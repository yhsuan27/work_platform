<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å·¥ä½œå§”è¨—å¹³å°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #5568d3; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ğŸš€ å·¥ä½œå§”è¨—å¹³å°</h1>
    
    <!-- ç™»å…¥è¨»å†Š -->
    <div id="auth" class="card">
        <h2>ç™»å…¥ / è¨»å†Š</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <select id="role">
            <option value="client">å§”è¨—äºº</option>
            <option value="contractor">æ¥æ¡ˆäºº</option>
        </select>
        <button onclick="doRegister()">è¨»å†Š</button>
        <button onclick="doLogin()">ç™»å…¥</button>
    </div>

    <!-- å§”è¨—äºº -->
    <div id="client" class="card hidden">
        <h2>å§”è¨—äººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="clientName"></strong></p>
        <h3>å»ºç«‹å°ˆæ¡ˆ</h3>
        <input type="text" id="title" placeholder="å°ˆæ¡ˆæ¨™é¡Œ">
        <textarea id="desc" placeholder="å°ˆæ¡ˆæè¿°"></textarea>
        <input type="number" id="budget" placeholder="é ç®—">
        <button onclick="createProject()">å»ºç«‹å°ˆæ¡ˆ</button>
        <button onclick="loadMyProjects()">æŸ¥çœ‹æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="clientProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>

    <!-- æ¥æ¡ˆäºº -->
    <div id="contractor" class="card hidden">
        <h2>æ¥æ¡ˆäººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="contractorName"></strong></p>
        <button onclick="loadOpenProjects()">ç€è¦½å°ˆæ¡ˆ</button>
        <div id="openProjects"></div>
        <button onclick="loadMyProjects()">æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="contractorProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>

    <!-- Issue é¢æ¿ -->
    <div id="issuePanel" class="card hidden">
        <h2>Issue / çµæ¡ˆå¾…è™•ç†äº‹é …</h2>
        <button onclick="closeIssuePanel()">é—œé–‰</button>
        <div id="issueContent" style="margin-top: 10px;"></div>
    </div>

    <script>
        const API = 'http://127.0.0.1:8080';
        let user = null;
        let currentIssueProjectId = null; // ç›®å‰æ­£åœ¨æŸ¥çœ‹ Issue çš„å°ˆæ¡ˆ ID

        function doRegister() {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };

            fetch(API + '/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
            })
            .catch(e => alert('éŒ¯èª¤ï¼š' + e));
        }

        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            fetch(API + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                user = d.user;
                document.getElementById('auth').classList.add('hidden');
                
                if (user.role === 'client') {
                    document.getElementById('client').classList.remove('hidden');
                    document.getElementById('clientName').textContent = user.username;
                } else {
                    document.getElementById('contractor').classList.remove('hidden');
                    document.getElementById('contractorName').textContent = user.username;
                }
            })
            .catch(e => alert('ç™»å…¥å¤±æ•—'));
        }

        function doLogout() {
            user = null;
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('client').classList.add('hidden');
            document.getElementById('contractor').classList.add('hidden');
            closeIssuePanel();
        }

        function createProject() {
            const data = {
                title: document.getElementById('title').value,
                description: document.getElementById('desc').value,
                budget: parseFloat(document.getElementById('budget').value)
            };

            fetch(API + '/projects/?client_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                alert('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
                loadMyProjects();
            });
        }

        function loadMyProjects() {
            fetch(API + '/projects/user/' + user.id)
            .then(r => r.json())
            .then(projects => {
                const html = projects.map(p => 
                    `<div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:3px solid #667eea;">
                        <strong>${p.title}</strong><br>
                        ${p.description}<br>
                        é ç®—: ${p.budget} | ç‹€æ…‹: ${p.status}
                        ${getActions(p)}
                    </div>`
                ).join('');
                
                if (user.role === 'client') {
                    document.getElementById('clientProjects').innerHTML = html;
                } else {
                    document.getElementById('contractorProjects').innerHTML = html;
                }
            });
        }

        function loadOpenProjects() {
            fetch(API + '/projects/')
            .then(r => r.json())
            .then(projects => {
                const html = projects.map(p => 
                    `<div style="background:#f9f9f9; padding:10px; margin:10px 0;">
                        <strong>${p.title}</strong><br>
                        ${p.description}<br>
                        é ç®—: ${p.budget}
                        <button onclick="makeProposal(${p.id})">æå‡ºå ±åƒ¹</button>
                    </div>`
                ).join('');
                document.getElementById('openProjects').innerHTML = html;
            });
        }

        function makeProposal(pid) {
            const price = prompt('å ±åƒ¹é‡‘é¡ï¼š');
            const desc = prompt('ææ¡ˆèªªæ˜ï¼š');
            
            fetch(API + '/projects/' + pid + '/proposals?contractor_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project_id: pid, price: parseFloat(price), description: desc})
            })
            .then(r => r.json())
            .then(d => alert('ææ¡ˆå·²é€å‡ºï¼'));
        }

        function selectContractor(pid) {
            fetch(API + '/projects/' + pid + '/proposals')
            .then(r => r.json())
            .then(proposals => {
                const list = proposals.map((p, i) => `${i+1}. ID:${p.contractor_id} - $${p.price}`).join('\n');
                const choice = prompt('é¸æ“‡æ¥æ¡ˆäººï¼š\n' + list);
                if (choice) {
                    const selected = proposals[parseInt(choice)-1];
                    fetch(API + '/projects/' + pid + '/select-contractor?contractor_id=' + selected.contractor_id, {method: 'POST'})
                    .then(() => {
                        alert('å·²é¸æ“‡æ¥æ¡ˆäººï¼');
                        loadMyProjects();
                    });
                }
            });
        }

        function submitWork(pid) {
            const url = prompt('çµæ¡ˆæª”æ¡ˆç¶²å€ï¼š');
            fetch(API + '/projects/' + pid + '/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({submission_file_url: url})
            })
            .then(() => {
                alert('å·²æäº¤ï¼');
                loadMyProjects();
            });
        }

        function acceptWork(pid) {
            fetch(API + '/projects/' + pid + '/accept', {method: 'POST'})
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    if (r.status === 400 && err.detail) {
                        alert('ç„¡æ³•çµæ¡ˆï¼š' + err.detail);
                        // è‹¥å› ç‚ºæœ‰æœªè™•ç† Issue ç„¡æ³•çµæ¡ˆï¼Œå¹«ä½ æ‰“é–‹ Issue é¢æ¿
                        viewIssues(pid);
                    } else {
                        alert('æ¥å—çµæ¡ˆå¤±æ•—');
                    }
                    throw new Error('accept failed');
                }
                return r.json();
            })
            .then(() => {
                alert('å·²æ¥å—çµæ¡ˆï¼');
                loadMyProjects();
            })
            .catch(e => console.log(e));
        }

        function rejectWork(pid) {
            const reason = prompt('é€€ä»¶åŸå› ï¼š');
            fetch(API + '/projects/' + pid + '/reject', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rejection_reason: reason})
            })
            .then(() => {
                alert('å·²é€€ä»¶ï¼');
                loadMyProjects();
            });
        }

        function editProject(pid) {
            // å…ˆå–å¾—å°ˆæ¡ˆè³‡æ–™
            fetch(API + '/projects/' + pid)
            .then(r => r.json())
            .then(project => {
                const newTitle = prompt('ä¿®æ”¹æ¨™é¡Œï¼š', project.title);
                if (!newTitle) return;
                
                const newDesc = prompt('ä¿®æ”¹æè¿°ï¼š', project.description);
                if (!newDesc) return;
                
                const newBudget = prompt('ä¿®æ”¹é ç®—ï¼š', project.budget);
                if (!newBudget) return;
                
                // é€å‡ºæ›´æ–°
                fetch(API + '/projects/' + pid, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDesc,
                        budget: parseFloat(newBudget)
                    })
                })
                .then(r => r.json())
                .then(() => {
                    alert('å°ˆæ¡ˆå·²æ›´æ–°ï¼');
                    loadMyProjects();
                })
                .catch(e => alert('æ›´æ–°å¤±æ•—ï¼š' + e));
            });
        }

        // ========== Issue å‰ç«¯åŠŸèƒ½ ==========

        function closeIssuePanel() {
            document.getElementById('issuePanel').classList.add('hidden');
            document.getElementById('issueContent').innerHTML = '';
            currentIssueProjectId = null;
        }

        function createIssue(pid) {
            const title = prompt('Issue æ¨™é¡Œï¼š');
            if (!title) return;
            const desc = prompt('Issue æè¿°ï¼ˆå¯ç•™ç©ºï¼‰ï¼š') || '';
            
            fetch(API + '/projects/' + pid + '/issues?creator_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title, description: desc})
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(issue => {
                alert('Issue å·²å»ºç«‹ï¼');
                viewIssues(pid);
            })
            .catch(e => alert('å»ºç«‹ Issue å¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        function viewIssues(pid) {
            currentIssueProjectId = pid;
            fetch(API + '/projects/' + pid + '/issues')
            .then(r => r.json())
            .then(issues => {
                const container = document.getElementById('issueContent');
                let html = `<p>å°ˆæ¡ˆ ID: ${pid} çš„ Issue åˆ—è¡¨</p>`;
                
                if (user.role === 'client') {
                    html += `<button onclick="createIssue(${pid})">ï¼‹ æ–°å¢ Issue</button>`;
                }

                if (issues.length === 0) {
                    html += `<p style="margin-top:10px;">ç›®å‰å°šç„¡ Issueã€‚</p>`;
                } else {
                    html += issues.map(i => `
                        <div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:3px solid ${i.status === 'open' ? '#ff9800' : '#4caf50'};">
                            <strong>[${i.status === 'open' ? 'å¾…è™•ç†' : 'å·²å®Œæˆ'}] ${i.title}</strong><br>
                            ${i.description || ''}<br>
                            å»ºç«‹æ™‚é–“ï¼š${new Date(i.created_at).toLocaleString()}<br>
                            ${i.resolved_at ? 'å®Œæˆæ™‚é–“ï¼š' + new Date(i.resolved_at).toLocaleString() + '<br>' : ''}
                            <button onclick="showIssueComments(${i.id})">æŸ¥çœ‹ç•™è¨€</button>
                            <button onclick="addIssueComment(${i.id})">æ–°å¢ç•™è¨€</button>
                            ${user.role === 'client' && i.status === 'open'
                                ? `<button onclick="resolveIssue(${i.id})">æ¨™è¨˜ç‚ºå·²å®Œæˆ</button>`
                                : ''}
                        </div>
                    `).join('');
                }

                container.innerHTML = html;
                document.getElementById('issuePanel').classList.remove('hidden');
            });
        }

        function showIssueComments(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments')
            .then(r => r.json())
            .then(comments => {
                if (comments.length === 0) {
                    alert('ç›®å‰æ²’æœ‰ç•™è¨€');
                    return;
                }
                const text = comments.map(c => 
                    `#${c.id} ä¾†è‡ªä½¿ç”¨è€… ${c.sender_id}ï¼š\n${c.content}\næ™‚é–“ï¼š${new Date(c.created_at).toLocaleString()}`
                ).join('\n\n---\n\n');
                alert(text);
            });
        }

        function addIssueComment(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            const content = prompt('ç•™è¨€å…§å®¹ï¼š');
            if (!content) return;

            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments?sender_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: content})
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(() => {
                alert('ç•™è¨€å·²é€å‡ºï¼');
            })
            .catch(e => alert('ç•™è¨€å¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        function resolveIssue(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            if (!confirm('ç¢ºèªå°‡æ­¤ Issue æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Ÿ')) return;

            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/resolve?resolver_id=' + user.id, {
                method: 'POST'
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(() => {
                alert('Issue å·²æ¨™è¨˜ç‚ºå®Œæˆï¼');
                viewIssues(currentIssueProjectId);
                loadMyProjects();
            })
            .catch(e => alert('æ“ä½œå¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        // ========== æ ¹æ“šè§’è‰²èˆ‡å°ˆæ¡ˆç‹€æ…‹é¡¯ç¤ºæŒ‰éˆ• ==========

        function getActions(p) {
            if (user.role === 'client') {
                if (p.status === 'open') {
                    return `<br>
                        <button onclick="editProject(${p.id})">ä¿®æ”¹å°ˆæ¡ˆ</button>
                        <button onclick="selectContractor(${p.id})">é¸æ“‡æ¥æ¡ˆäºº</button>`;
                } else if (p.status === 'submitted') {
                    return `<br>
                        <button onclick="viewIssues(${p.id})">æŸ¥çœ‹ / ç®¡ç† Issue</button>
                        <button onclick="createIssue(${p.id})">æ–°å¢ Issue</button>
                        <button onclick="acceptWork(${p.id})">æ¥å—</button>
                        <button onclick="rejectWork(${p.id})">é€€ä»¶</button>`;
                }
            } else {
                // æ¥æ¡ˆäººçš„æ“ä½œ
                if (p.contractor_id === user.id) {
                    if (p.status === 'in_progress') {
                        return `<br><button onclick="submitWork(${p.id})">ä¸Šå‚³çµæ¡ˆ</button>`;
                    } else if (p.status === 'rejected') {
                        return `<br><button onclick="submitWork(${p.id})" style="background:#ff9800;">é‡æ–°æäº¤çµæ¡ˆ</button>`;
                    } else if (p.status === 'submitted') {
                        return `<br><button onclick="viewIssues(${p.id})">æŸ¥çœ‹ Issue / è¨è«–</button>`;
                    }
                }
            }
            return '';
        }
    </script>
</body>
</html>