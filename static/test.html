<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å·¥ä½œå§”è¨—å¹³å°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #5568d3; }
        .hidden { display: none; }

        /* Feature åˆ†æ”¯æ¨£å¼ */
        .sub-btn {
            width: auto;
            padding: 6px 10px;
            margin-top: 5px;
            font-size: 13px;
            margin-right: 5px;
        }
        .version-list {
            margin-top: 6px;
            font-size: 13px;
            padding-left: 4px;
            border-left: 2px solid #ccc;
        }
        .version-list a {
            text-decoration: underline;
            color: #007bff;
        }

        /* Main åˆ†æ”¯æ¨£å¼ (è©•è«–) */
        .review-box {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .review-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px; 
        }
        .review-item {
            background: #fff;
            border-left: 4px solid #667eea;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .review-meta {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 4px;
        }

        /* --- å½ˆå‡ºè¦–çª— (Modal) æ¨£å¼ --- */
        .modal {
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }
        .close-btn:hover { color: #000; }

        /* --- å¯é»æ“Šæ–‡å­—æ¨£å¼ --- */
        .clickable-text {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-weight: normal;
            margin-left: 5px;
        }
        .clickable-text:hover { color: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸš€ å·¥ä½œå§”è¨—å¹³å°</h1>
    
    <div id="auth" class="card">
        <h2>ç™»å…¥ / è¨»å†Š</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <select id="role">
            <option value="client">å§”è¨—äºº</option>
            <option value="contractor">æ¥æ¡ˆäºº</option>
        </select>
        <button onclick="doRegister()">è¨»å†Š</button>
        <button onclick="doLogin()">ç™»å…¥</button>
    </div>

    <div id="client" class="card hidden">
        <h2>å§”è¨—äººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="clientName"></strong></p>
        
        <h3>å»ºç«‹å°ˆæ¡ˆ</h3>
        <input type="text" id="title" placeholder="å°ˆæ¡ˆæ¨™é¡Œ">
        <textarea id="desc" placeholder="å°ˆæ¡ˆæè¿°"></textarea>
        <input type="number" id="budget" placeholder="é ç®—">
        <label for="deadline">æˆªæ­¢æ™‚é–“ï¼ˆé™æ™‚ç«¶æ¨™ï¼‰ï¼š</label>
        <input type="datetime-local" id="deadline">

        <button onclick="createProject()">å»ºç«‹å°ˆæ¡ˆ</button>
        <button onclick="loadMyProjects()">æŸ¥çœ‹æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="clientProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>

    <div id="contractor" class="card hidden">
        <h2>æ¥æ¡ˆäººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="contractorName"></strong></p>

        <button onclick="loadOpenProjects()">ç€è¦½å°ˆæ¡ˆ</button>
        <div id="openProjects"></div>
        <button onclick="loadMyProjects()">æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="contractorProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>
   
    <div id="issuePanel" class="card hidden">
        <h2>Issue / çµæ¡ˆå¾…è™•ç†äº‹é …</h2>
        <button onclick="closeIssuePanel()">é—œé–‰</button>
        <div id="issueContent" style="margin-top: 10px;"></div>
    </div>

    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeReviewModal()">&times;</span>
            <h3>ğŸ“œ è©³ç´°è©•è«–ç´€éŒ„</h3>
            <div id="modalBody"></div>
        </div>
    </div>


<script>
        const API = 'http://127.0.0.1:8080';
        let user = null;
        let currentIssueProjectId = null; // ç›®å‰æ­£åœ¨æŸ¥çœ‹ Issue çš„å°ˆæ¡ˆ ID
        
        // ==========================================
        //  ã€è©•åƒ¹æ©Ÿåˆ¶åŠŸèƒ½å€ã€‘
        // ==========================================

        // 1. å–å¾—å¹³å‡è©•åƒ¹ (GET)
        async function fetchAverageRating(userId) {
            try {
                const response = await fetch(API + '/projects/user/' + userId + '/average-rating');
                const data = await response.json();
                
                if (data.total_ratings > 0) {
                    const avgScore = data.average_score.toFixed(1); 
                    const stars = 'â˜…'.repeat(Math.round(avgScore));
                    
                    return `
                        å¹³å‡åˆ†æ•¸: ${avgScore} / 5.0 ${stars} 
                        <span class="clickable-text" onclick="openReviewModal(${userId})">
                            (${data.total_ratings} ç­†è©•åƒ¹)
                        </span>
                    `;
                }
                return 'ç›®å‰å°šç„¡è©•åƒ¹ã€‚';
            } catch (e) {
                return 'ç„¡æ³•è¼‰å…¥è©•åƒ¹æ•¸æ“šã€‚';
            }
        }

        // 2. å–å¾—è©³ç´°è©•è«–åˆ—è¡¨ (GET)
        async function fetchUserReviews(userId) {
            try {
                const response = await fetch(API + `/projects/user/${userId}/reviews`);
                if (response.ok) {
                    return await response.json();
                }
                return [];
            } catch (e) {
                console.error("Error fetching reviews:", e);
                return [];
            }
        }
        
        // 3. æª¢æŸ¥å–®ç­†è©•åƒ¹ (GET)
        async function getRating(projectId, raterId) {
            try {
                const response = await fetch(API + `/projects/${projectId}/rate?rater_id=${raterId}`);
                if (response.ok) {
                    return await response.json();
                }
                return null; 
            } catch (e) {
                return null;
            }
        }

        // 4. é–‹å•Ÿè©•è«–å½ˆçª—
        async function openReviewModal(userId) {
            const modal = document.getElementById('reviewModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = '<p style="text-align:center; color:#666;">è¼‰å…¥ä¸­...</p>';
            modal.classList.add('show'); 

            const reviews = await fetchUserReviews(userId);

            if (reviews.length > 0) {
                let html = '<div class="review-list">';
                
                reviews.forEach(r => {
                    const commentText = r.comment ? r.comment : '<span style="color:#aaa;">(ç„¡æ–‡å­—è©•è«–)</span>';
                    
                    // --- è¨ˆç®—é€™ç­†è©•è«–çš„å¹³å‡åˆ† ---
                    const scores = [
                        r.cooperation_attitude,
                        r.output_quality,
                        r.execution_efficiency,
                        r.demand_reasonableness,
                        r.acceptance_difficulty
                    ];
                    const validScores = scores.filter(s => s !== null && s !== undefined);
                    
                    let finalScore = 0;
                    if (validScores.length > 0) {
                        const sum = validScores.reduce((a, b) => a + b, 0);
                        finalScore = (sum / validScores.length).toFixed(1);
                    }

                    html += `
                        <div class="review-item">
                            <div class="review-meta" style="display:flex; justify-content:space-between;">
                                <span>ä¾†è‡ª ID: ${r.rater_id}</span>
                                <span style="color:#f39c12; font-weight:bold;">â˜… ${finalScore}</span>
                            </div>
                            <div style="margin-top:5px; color:#333;">${commentText}</div>
                        </div>`;
                });
                html += '</div>';
                modalBody.innerHTML = html;
            } else {
                modalBody.innerHTML = '<p style="text-align:center; color:#888;">æ­¤ä½¿ç”¨è€…ç›®å‰æ²’æœ‰è©³ç´°æ–‡å­—è©•è«–ã€‚</p>';
            }
        }

        // 5. é—œé–‰è©•è«–å½ˆçª—
        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target == modal) {
                closeReviewModal();
            }
        }

        // 6. é¡¯ç¤ºè©•åƒ¹è¡¨å–®
        function showRatingForm(projectId, ratedUserId, roleToRate, existingRating = null) {
            const targetDiv = document.getElementById(`rating-form-${projectId}`);
            const currentRaterId = user.id;
            
            const isUpdate = existingRating !== null;
            const actionText = isUpdate ? 'ä¿®æ”¹' : 'æäº¤';
            const buttonColor = isUpdate ? '#1e88e5' : '#38c172';
            
            const defaults = {
                cooperation: existingRating?.cooperation_attitude || 5.0,
                quality: existingRating?.output_quality || 4.5,
                efficiency: existingRating?.execution_efficiency || 4.0,
                reasonableness: existingRating?.demand_reasonableness || 4.0,
                difficulty: existingRating?.acceptance_difficulty || 3.5,
                comment: existingRating?.comment || 'è«‹è¼¸å…¥è©•è«–...'
            };

            targetDiv.innerHTML = `
                <div style="padding: 15px; background: ${isUpdate ? '#e3f2fd' : '#fff8e1'}; border: 1px dashed ${isUpdate ? '#2196f3' : '#ffc107'}; margin-top: 10px;">
                    <h4>å° ${roleToRate} (ID: ${ratedUserId}) ${actionText}è©•åƒ¹</h4>
                    <form id="rate-form-${projectId}">
                        <input type="hidden" name="rater_id" value="${currentRaterId}">
                        <input type="hidden" name="rated_user_id" value="${ratedUserId}">
                        
                        <label>åˆä½œæ…‹åº¦ (1-5):</label>
                        <input type="number" name="cooperation_attitude" value="${defaults.cooperation}" min="1.0" max="5.0" step="0.5" required><br>
                        
                        ${roleToRate === 'æ¥æ¡ˆäºº' ? `
                            <label>ç”¢å‡ºå“è³ª (1-5):</label>
                            <input type="number" name="output_quality" value="${defaults.quality}" min="1.0" max="5.0" step="0.5"><br>
                            <label>åŸ·è¡Œæ•ˆç‡ (1-5):</label>
                            <input type="number" name="execution_efficiency" value="${defaults.efficiency}" min="1.0" max="5.0" step="0.5"><br>
                        ` : `
                            <label>éœ€æ±‚åˆç†æ€§ (1-5):</label>
                            <input type="number" name="demand_reasonableness" value="${defaults.reasonableness}" min="1.0" max="5.0" step="0.5"><br>
                            <label>é©—æ”¶é›£åº¦ (1-5):</label>
                            <input type="number" name="acceptance_difficulty" value="${defaults.difficulty}" min="1.0" max="5.0" step="0.5"><br>
                        `}
                        
                        <label>è©•è«–:</label>
                        <textarea name="comment" rows="2">${defaults.comment}</textarea>
                        
                        <button type="submit" style="background: ${buttonColor};">ç¢ºèª${actionText}è©•åƒ¹</button>
                        <p id="message-${projectId}" style="margin-top: 5px;"></p>
                    </form>
                </div>
            `;

            document.getElementById(`rate-form-${projectId}`).addEventListener('submit', function(e) {
                e.preventDefault();
                submitRating(projectId, isUpdate);
            });
        }

        // 7. æäº¤è©•åƒ¹é‚è¼¯
        async function submitRating(projectId, isUpdate = false) {
            const form = document.getElementById(`rate-form-${projectId}`);
            const messageDiv = document.getElementById(`message-${projectId}`);
            const formData = new FormData(form);
            const data = {};

            for (const [key, value] of formData.entries()) {
                if (key !== 'comment' && value !== '') {
                    data[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
                } else if (key === 'comment') {
                    data[key] = value;
                }
            }
            Object.keys(data).forEach(key => (data[key] === '' || data[key] == null) && delete data[key]);

            messageDiv.textContent = isUpdate ? 'ä¿®æ”¹ä¸­...' : 'æäº¤ä¸­...';
            messageDiv.style.color = 'blue';

            const method = isUpdate ? 'PUT' : 'POST';

            try {
                const response = await fetch(API + `/projects/${projectId}/rate`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (!isUpdate) {
                        const ratedUserId = data.rated_user_id;
                        const roleToRate = document.querySelector(`#rating-form-${projectId} h4`).innerText.includes('æ¥æ¡ˆäºº') ? 'æ¥æ¡ˆäºº' : 'å§”è¨—äºº';
                        
                        await showRatingForm(projectId, ratedUserId, roleToRate, result);
                        
                        document.getElementById(`message-${projectId}`).textContent = `è©•åƒ¹æäº¤æˆåŠŸï¼è¡¨å–®å·²åˆ‡æ›ç‚ºä¿®æ”¹æ¨¡å¼ã€‚`;
                        document.getElementById(`message-${projectId}`).style.color = 'green';
                    } else {
                        messageDiv.textContent = `è©•åƒ¹ä¿®æ”¹æˆåŠŸï¼`;
                        messageDiv.style.color = 'green';
                    }

                    loadMyProjects(); 
                    displayAverageRatingArea(user.id); 
                } else {
                    const err = await response.json();
                    if (response.status === 409 && !isUpdate) {
                        messageDiv.textContent = 'æäº¤å¤±æ•—ï¼šæ‚¨å·²è©•åƒ¹éï¼Œè«‹é»æ“Šã€Œä¿®æ”¹è©•åƒ¹ã€æŒ‰éˆ•ã€‚';
                        messageDiv.style.color = 'orange';
                    } else {
                        throw new Error(err.detail || 'æ“ä½œå¤±æ•—');
                    }
                }
            } catch (error) {
                messageDiv.textContent = `éŒ¯èª¤: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }

        // 8. é¡¯ç¤ºä½¿ç”¨è€…å¹³å‡è©•åƒ¹
        async function displayAverageRatingArea(userId) {
             const avgRatingText = await fetchAverageRating(userId);
             const targetDiv = document.getElementById(user.role === 'client' ? 'client' : 'contractor');
             
             let oldDiv = document.getElementById('user-avg-rating');
             if (oldDiv) oldDiv.remove();

             const avgDiv = document.createElement('div');
             avgDiv.id = 'user-avg-rating';
             avgDiv.className = 'card';
             avgDiv.style.backgroundColor = '#e6e6fa';
             
             avgDiv.innerHTML = `<h3>â­ æˆ‘çš„å¹³å‡è©•åƒ¹</h3><p>${avgRatingText}</p>`;
             
             targetDiv.insertBefore(avgDiv, targetDiv.querySelector('h2').nextSibling);
        }

        // ==========================================
        //  ã€åŸæœ‰åŠŸèƒ½å€ (å«èº«åˆ†é©—è­‰)ã€‘
        // ==========================================

        function doRegister() {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };

            fetch(API + '/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
            })
            .catch(e => alert('éŒ¯èª¤ï¼š' + e));
        }

        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            fetch(API + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                user = d.user;
                if (!user) {
                    alert('ç™»å…¥å¤±æ•—');
                    return;
                }
                document.getElementById('auth').classList.add('hidden');
                
                if (user.role === 'client') {
                    document.getElementById('client').classList.remove('hidden');
                    document.getElementById('clientName').textContent = user.username;
                } else {
                    document.getElementById('contractor').classList.remove('hidden');
                    document.getElementById('contractorName').textContent = user.username;
                }
                
                loadMyProjects();
                displayAverageRatingArea(user.id);
            })
            .catch(() => alert('ç™»å…¥å¤±æ•—'));
        }

        function doLogout() {
            user = null;
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('client').classList.add('hidden');
            document.getElementById('contractor').classList.add('hidden');
            closeIssuePanel();
            window.location.reload(); 
        }

        // ================== å°ˆæ¡ˆå»ºç«‹ / æŸ¥è©¢ ==================

        function createProject() {
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const budget = parseFloat(document.getElementById('budget').value);

            const deadlineInput = document.getElementById('deadline').value;
            let deadline = null;
            if (deadlineInput) {
                deadline = deadlineInput + ':00'; 
            }

            const data = {
                title: title,
                description: desc,
                budget: budget,
                deadline: deadline
            };

            fetch(API + '/projects/?client_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                alert('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
                loadMyProjects();
            });
        }

        function formatDeadline(deadline) {
            if (!deadline) return 'æœªè¨­å®š';
            try {
                return new Date(deadline).toLocaleString();
            } catch {
                return deadline;
            }
        }

        function loadMyProjects() {
            fetch(API + '/projects/user/' + user.id)
            .then(r => r.json())
            .then(projects => {
                // ä½¿ç”¨ async/await è™•ç†è©•åƒ¹è³‡æ–™çš„ç²å–
                const projectPromises = projects.map(async p => {
                     let clientRatingText = '';
                     let contractorRatingText = '';
                     
                     if (p.status === 'completed' && p.contractor_id) {
                        clientRatingText = await fetchAverageRating(p.client_id);
                        contractorRatingText = await fetchAverageRating(p.contractor_id);
                     }

                    const actionsHtml = await getActions(p);

                    // çµæ¡ˆç¶²å€é¡¯ç¤ºé‚è¼¯
                    const submissionLink = p.submission_file_url
                            ? `<a href="${API}${p.submission_file_url}" target="_blank" rel="noopener">ä¸‹è¼‰</a>`
                            : 'å°šæœªçµæ¡ˆ';

                    return `<div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:3px solid #667eea;">
                        <strong>ID: ${p.id} - ${p.title}</strong><br>
                        ${p.description}<br>
                        é ç®—: ${p.budget ?? 'æœªè¨­å®š'} | ç‹€æ…‹: <strong>${p.status}</strong><br>
                        æˆªæ­¢æ™‚é–“: ${formatDeadline(p.deadline)}<br>
                        æœ€æ–°çµæ¡ˆç¶²å€: ${submissionLink}<br>
                        
                        ${p.status === 'completed' && p.contractor_id ? 
                            `<div style="margin-top: 5px; color: #555;">
                                <div>å§”è¨—äººå¹³å‡: ${clientRatingText}</div>
                                <div>æ¥æ¡ˆäººå¹³å‡: ${contractorRatingText}</div>
                             </div>` : ''}
                             
                        ${actionsHtml}
                        <div id="versions-${p.id}" class="version-list"></div>
                    </div>`;
                });

                Promise.all(projectPromises).then(htmlArray => {
                    const html = htmlArray.join('');
                    if (user.role === 'client') {
                        document.getElementById('clientProjects').innerHTML = html;
                    } else {
                        document.getElementById('contractorProjects').innerHTML = html;
                    }
                });
            });
        }

        function loadOpenProjects() {
            fetch(API + '/projects/')
            .then(r => r.json())
            .then(projects => {
                const projectPromises = projects.map(async p => {
                    const clientRatingHtml = await fetchAverageRating(p.client_id);

                    return `<div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:5px solid #e67e22;">
                        <strong>${p.title}</strong><br>
                        
                        <div style="margin: 5px 0; font-size: 0.9em; background: #fff3e0; padding: 5px; border-radius: 4px;">
                            å§”è¨—äººä¿¡ç”¨: ${clientRatingHtml}
                        </div>

                        ${p.description}<br>
                        é ç®—: ${p.budget ?? 'æœªè¨­å®š'}<br>
                        æˆªæ­¢æ™‚é–“: ${formatDeadline(p.deadline)}<br><br>
                        
                        å ±åƒ¹é‡‘é¡ï¼š<input type="number" id="price-${p.id}" placeholder="é‡‘é¡"><br>
                        ææ¡ˆèªªæ˜ï¼š<input type="text" id="pdesc-${p.id}" placeholder="ç°¡çŸ­èªªæ˜"><br>
                        ä¸Šå‚³ææ¡ˆ PDFï¼š<input type="file" id="pfile-${p.id}" accept="application/pdf"><br>
                        <button class="sub-btn" onclick="makeProposal(${p.id})">æå‡ºå ±åƒ¹</button>
                    </div>`;
                });

                Promise.all(projectPromises).then(htmlArray => {
                    document.getElementById('openProjects').innerHTML = htmlArray.join('');
                });
            });
        }

        // ================== ææ¡ˆï¼ˆå« PDF ä¸Šå‚³ï¼‰ ==================

        async function makeProposal(pid) {
            const priceInput = document.getElementById(`price-${pid}`);
            const descInput  = document.getElementById(`pdesc-${pid}`);
            const fileInput  = document.getElementById(`pfile-${pid}`);

            const priceVal = parseFloat(priceInput.value);
            const desc = descInput.value;
            const file = fileInput.files[0];

            if (isNaN(priceVal)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å ±åƒ¹é‡‘é¡');
                return;
            }
            if (!file) {
                alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„ PDF æª”æ¡ˆ');
                return;
            }
            if (file.type !== 'application/pdf') {
                alert('åƒ…æ¥å— PDF æª”æ¡ˆ');
                return;
            }

            const formData = new FormData();
            formData.append('price', priceVal);
            formData.append('description', desc);
            formData.append('file', file);

            try {
                const resp = await fetch(
                    API + '/projects/' + pid + '/proposals?contractor_id=' + user.id,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                const data = await resp.json();

                if (!resp.ok) {
                    alert('ææ¡ˆå¤±æ•—ï¼š' + (data.detail || JSON.stringify(data)));
                    return;
                }

                alert('ææ¡ˆå·²é€å‡ºï¼(ID: ' + (data.proposal_id || '') + ')');
            } catch (e) {
                alert('ææ¡ˆå¤±æ•—(ç¶²è·¯éŒ¯èª¤)ï¼š' + e);
            }
        }

        // ================== é¸æ“‡æ¥æ¡ˆäºº & çµæ¡ˆ ==================

        function selectContractor(pid) {
            fetch(API + `/projects/${pid}/proposals`)
            .then(r => r.json())
            .then(async proposals => { 
                
                if (proposals.length === 0) {
                    alert("ç›®å‰é‚„æ²’æœ‰äººææ¡ˆå–”ï¼");
                    return;
                }

                const listPromises = proposals.map(async (p, i) => {
                    let scoreText = "ç„¡è©•åƒ¹";
                    try {
                        const res = await fetch(API + '/projects/user/' + p.contractor_id + '/average-rating');
                        const data = await res.json();
                        if (data.total_ratings > 0) {
                            scoreText = `${data.average_score}â˜… (${data.total_ratings}è©•)`;
                        }
                    } catch (e) {
                        scoreText = "è®€å–å¤±æ•—";
                    }
                    
                    return `${i+1}. ææ¡ˆID:${p.id} / æ¥æ¡ˆäººID:${p.contractor_id} [è©•åˆ†: ${scoreText}] - $${p.price}\n   èªªæ˜: ${p.description}`;
                });

                const listItems = await Promise.all(listPromises);
                const listStr = listItems.join('\n\n');

                const choice = prompt('è«‹è¼¸å…¥ç·¨è™Ÿé¸æ“‡æ¥æ¡ˆäººï¼š\n\n' + listStr);
                
                if (choice) {
                    const index = parseInt(choice) - 1;
                    if (index >= 0 && index < proposals.length) {
                        const selected = proposals[index];
                        fetch(API + '/projects/' + pid + '/select-contractor?contractor_id=' + selected.contractor_id, {method: 'POST'})
                        .then(() => {
                            alert('å·²é¸æ“‡æ¥æ¡ˆäººï¼');
                            loadMyProjects();
                        });
                    }
                }
            });
        }

        async function submitWork(pid) {
            const fileInput = document.getElementById(`submit-file-${pid}`);
            if (!fileInput || fileInput.files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„çµæ¡ˆæª”æ¡ˆ');
                return;
            }
            const file = fileInput.files[0];

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch(API + `/projects/${pid}/submit`, {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    throw new Error(data.detail || resp.statusText);
                }

                alert('å·²æäº¤çµæ¡ˆï¼');
                loadMyProjects();
            } catch (e) {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + e);
            }
        }

        function acceptWork(pid) {
            fetch(API + '/projects/' + pid + '/accept', {method: 'POST'})
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    if (r.status === 400 && err.detail) {
                        alert('ç„¡æ³•çµæ¡ˆï¼š' + err.detail);
                        // è‹¥å› ç‚ºæœ‰æœªè™•ç† Issue ç„¡æ³•çµæ¡ˆï¼Œå¹«ä½ æ‰“é–‹ Issue é¢æ¿
                        viewIssues(pid);
                    } else {
                        alert('æ¥å—çµæ¡ˆå¤±æ•—');
                    }
                    throw new Error('accept failed');
                }
                return r.json();
            })
            .then(() => {
                alert('å·²æ¥å—çµæ¡ˆï¼');
                loadMyProjects();
            })
            .catch(e => console.log(e));
        }

        function rejectWork(pid) {
            const reason = prompt('é€€ä»¶åŸå› ï¼š');
            if (!reason) return;

            fetch(API + `/projects/${pid}/reject`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rejection_reason: reason})
            })
            .then(() => {
                alert('å·²é€€ä»¶ï¼');
                loadMyProjects();
            });
        }

        // ================== çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨ï¼ˆä¸‹è¼‰é€£çµï¼‰ ==================

        function showSubmissionVersions(pid) {
            fetch(API + `/projects/${pid}/submissions`)
            .then(r => r.json())
            .then(data => {
                let list = [];
                if (Array.isArray(data)) {
                    list = data;
                } else if (data && Array.isArray(data.versions)) {
                    list = data.versions;
                }

                const container = document.getElementById(`versions-${pid}`);

                if (!list || list.length === 0) {
                    container.innerHTML = 'ç›®å‰æ²’æœ‰ä»»ä½•çµæ¡ˆç‰ˆæœ¬';
                    return;
                }

                const html = list.map(v =>
                    `<div>v${v.version}ï¼š<a href="${API}${v.submit_url}" target="_blank" rel="noopener">ä¸‹è¼‰</a></div>`
                ).join('');

                container.innerHTML = html;
            })
            .catch(e => {
                alert('è®€å–ç‰ˆæœ¬åˆ—è¡¨å¤±æ•—ï¼š' + e);
            });
        }

        // ================== ä¿®æ”¹å°ˆæ¡ˆ (å«æˆªæ­¢æ™‚é–“) ==================

        function editProject(pid) {
            fetch(API + '/projects/' + pid)
            .then(r => r.json())
            .then(project => {
                const newTitle = prompt('ä¿®æ”¹æ¨™é¡Œï¼š', project.title);
                if (!newTitle) return;

                const newDesc = prompt('ä¿®æ”¹æè¿°ï¼š', project.description);
                if (!newDesc) return;

                const newBudget = prompt('ä¿®æ”¹é ç®—ï¼š', project.budget);
                if (!newBudget) return;

                const newDeadlineRaw = prompt(
                    'ä¿®æ”¹æˆªæ­¢æ™‚é–“ (åŸå€¼ï¼š' + formatDeadline(project.deadline) + ')\næ ¼å¼ï¼šYYYY-MM-DD HH:MMï¼Œç•™ç©ºè¡¨ç¤ºä¸è®Š'
                );
                let deadline = project.deadline;
                if (newDeadlineRaw) {
                    const safe = newDeadlineRaw.replace(' ', 'T');
                    deadline = safe + ':00'; 
                }

                fetch(API + `/projects/${pid}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDesc,
                        budget: parseFloat(newBudget),
                        deadline: deadline
                    })
                })
                .then(r => r.json())
                .then(() => {
                    alert('å°ˆæ¡ˆå·²æ›´æ–°ï¼');
                    loadMyProjects();
                })
                .catch(e => alert('æ›´æ–°å¤±æ•—ï¼š' + e));
            });
        }

        // ========== Issue å‰ç«¯åŠŸèƒ½ (ä¾†è‡ª Main) ==========

        function closeIssuePanel() {
            document.getElementById('issuePanel').classList.add('hidden');
            document.getElementById('issueContent').innerHTML = '';
            currentIssueProjectId = null;
        }

        function createIssue(pid) {
            const title = prompt('Issue æ¨™é¡Œï¼š');
            if (!title) return;
            const desc = prompt('Issue æè¿°ï¼ˆå¯ç•™ç©ºï¼‰ï¼š') || '';
            
            fetch(API + '/projects/' + pid + '/issues?creator_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title, description: desc})
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(issue => {
                alert('Issue å·²å»ºç«‹ï¼');
                viewIssues(pid);
            })
            .catch(e => alert('å»ºç«‹ Issue å¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        function viewIssues(pid) {
            currentIssueProjectId = pid;
            fetch(API + '/projects/' + pid + '/issues')
            .then(r => r.json())
            .then(issues => {
                const container = document.getElementById('issueContent');
                let html = `<p>å°ˆæ¡ˆ ID: ${pid} çš„ Issue åˆ—è¡¨</p>`;
                
                if (user.role === 'client') {
                    html += `<button onclick="createIssue(${pid})">ï¼‹ æ–°å¢ Issue</button>`;
                }

                if (issues.length === 0) {
                    html += `<p style="margin-top:10px;">ç›®å‰å°šç„¡ Issueã€‚</p>`;
                } else {
                    html += issues.map(i => `
                        <div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:3px solid ${i.status === 'open' ? '#ff9800' : '#4caf50'};">
                            <strong>[${i.status === 'open' ? 'å¾…è™•ç†' : 'å·²å®Œæˆ'}] ${i.title}</strong><br>
                            ${i.description || ''}<br>
                            å»ºç«‹æ™‚é–“ï¼š${new Date(i.created_at).toLocaleString()}<br>
                            ${i.resolved_at ? 'å®Œæˆæ™‚é–“ï¼š' + new Date(i.resolved_at).toLocaleString() + '<br>' : ''}
                            <button onclick="showIssueComments(${i.id})">æŸ¥çœ‹ç•™è¨€</button>
                            <button onclick="addIssueComment(${i.id})">æ–°å¢ç•™è¨€</button>
                            ${user.role === 'client' && i.status === 'open'
                                ? `<button onclick="resolveIssue(${i.id})">æ¨™è¨˜ç‚ºå·²å®Œæˆ</button>`
                                : ''}
                        </div>
                    `).join('');
                }

                container.innerHTML = html;
                document.getElementById('issuePanel').classList.remove('hidden');
            });
        }

        function showIssueComments(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments')
            .then(r => r.json())
            .then(comments => {
                if (comments.length === 0) {
                    alert('ç›®å‰æ²’æœ‰ç•™è¨€');
                    return;
                }
                const text = comments.map(c => 
                    `#${c.id} ä¾†è‡ªä½¿ç”¨è€… ${c.sender_id}ï¼š\n${c.content}\næ™‚é–“ï¼š${new Date(c.created_at).toLocaleString()}`
                ).join('\n\n---\n\n');
                alert(text);
            });
        }

        function addIssueComment(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            const content = prompt('ç•™è¨€å…§å®¹ï¼š');
            if (!content) return;

            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments?sender_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: content})
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(() => {
                alert('ç•™è¨€å·²é€å‡ºï¼');
            })
            .catch(e => alert('ç•™è¨€å¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        function resolveIssue(issueId) {
            if (!currentIssueProjectId) {
                alert('è«‹å…ˆå¾å°ˆæ¡ˆæ‰“é–‹ Issue åˆ—è¡¨');
                return;
            }
            if (!confirm('ç¢ºèªå°‡æ­¤ Issue æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Ÿ')) return;

            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/resolve?resolver_id=' + user.id, {
                method: 'POST'
            })
            .then(async r => {
                if (!r.ok) {
                    let err = {};
                    try { err = await r.json(); } catch (_) {}
                    throw err;
                }
                return r.json();
            })
            .then(() => {
                alert('Issue å·²æ¨™è¨˜ç‚ºå®Œæˆï¼');
                viewIssues(currentIssueProjectId);
                loadMyProjects();
            })
            .catch(e => alert('æ“ä½œå¤±æ•—ï¼š' + (e.detail || JSON.stringify(e))));
        }

        // ========== æ ¹æ“šè§’è‰²èˆ‡å°ˆæ¡ˆç‹€æ…‹é¡¯ç¤ºæŒ‰éˆ• (æ•´åˆåŠŸèƒ½ç‰ˆ) ==========

        async function getActions(p) { 
            let buttons = '';
            
            // 1. å¦‚æœå°ˆæ¡ˆå·²å®Œæˆï¼Œé¡¯ç¤ºè©•åƒ¹æŒ‰éˆ• (Main) & ç‰ˆæœ¬åˆ—è¡¨ (Feature)
            if (p.status === 'completed' && p.contractor_id) {
                const ratedDivId = `rating-form-${p.id}`;
                let ratedUserId, roleToRate;
                
                if (user.role === 'client' && user.id === p.client_id) {
                     ratedUserId = p.contractor_id;
                     roleToRate = 'æ¥æ¡ˆäºº';
                } else if (user.role === 'contractor' && user.id === p.contractor_id) {
                     ratedUserId = p.client_id;
                     roleToRate = 'å§”è¨—äºº';
                }

                if (ratedUserId) {
                    const existingRating = await getRating(p.id, user.id);
                    
                    if (existingRating) {
                        const ratingJson = JSON.stringify(existingRating).replace(/"/g, '&quot;');
                        buttons += `<button style="background: #1e88e5;" onclick="showRatingForm(${p.id}, ${ratedUserId}, '${roleToRate}', ${ratingJson})">ä¿®æ”¹è©•åƒ¹ ${roleToRate}</button>`;
                    } else {
                        buttons += `<button onclick="showRatingForm(${p.id}, ${ratedUserId}, '${roleToRate}')">è©•åƒ¹ ${roleToRate}</button>`;
                    }
                    buttons += `<div id="${ratedDivId}"></div>`;
                }
                // Feature: å®Œæˆä¹Ÿé¡¯ç¤ºç‰ˆæœ¬åˆ—è¡¨
                buttons += `<button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
            }
            
            // 2. æ ¹æ“šè§’è‰²é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
            if (user.role === 'client') {
                if (p.status === 'open') {
                    buttons += `<br>
                        <button class="sub-btn" onclick="editProject(${p.id})">ä¿®æ”¹å°ˆæ¡ˆ</button>
                        <button class="sub-btn" onclick="selectContractor(${p.id})">é¸æ“‡æ¥æ¡ˆäºº</button>`;
                } else if (p.status === 'submitted') {
                    // Main: Issue & Accept/Reject
                    // Feature: Show versions
                    buttons += `<br>
                        <button class="sub-btn" onclick="viewIssues(${p.id})">æŸ¥çœ‹ / ç®¡ç† Issue</button>
                        <button class="sub-btn" onclick="createIssue(${p.id})">æ–°å¢ Issue</button>
                        <button class="sub-btn" onclick="acceptWork(${p.id})" style="background:#4caf50;">æ¥å—</button> 
                        <button class="sub-btn" onclick="rejectWork(${p.id})" style="background:#f44336;">é€€ä»¶</button>
                        <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                }
            } else {
                // Contractor
                if (p.contractor_id === user.id) {
                    if (p.status === 'in_progress') {
                        // Feature: Upload with file
                        buttons += `<br>
                            <input type="file" id="submit-file-${p.id}">
                            <button class="sub-btn" onclick="submitWork(${p.id})">ä¸Šå‚³çµæ¡ˆ</button>`;
                    } else if (p.status === 'rejected') {
                        // Feature: Re-upload
                        buttons += `<br>
                            <input type="file" id="submit-file-${p.id}">
                            <button class="sub-btn" onclick="submitWork(${p.id})" style="background:#ff9800;">é‡æ–°æäº¤çµæ¡ˆ</button>
                            <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                    } else if (p.status === 'submitted') {
                        // Main: View Issues
                        buttons += `<br>
                            <button class="sub-btn" onclick="viewIssues(${p.id})">æŸ¥çœ‹ Issue / è¨è«–</button>
                            <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                    }
                }
            }
            return buttons;
        }
    </script>
</body>
</html>