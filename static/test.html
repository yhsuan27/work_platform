<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å·¥ä½œå§”è¨—å¹³å°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #666; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #5568d3; }
        .hidden { display: none; }
        .sub-btn {
            width: auto;
            padding: 6px 10px;
            margin-top: 5px;
            font-size: 13px;
        }
        .version-list {
            margin-top: 6px;
            font-size: 13px;
            padding-left: 4px;
            border-left: 2px solid #ccc;
        }
        .version-list a {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ å·¥ä½œå§”è¨—å¹³å°</h1>
    
    <!-- ç™»å…¥ / è¨»å†Š -->
    <div id="auth" class="card">
        <h2>ç™»å…¥ / è¨»å†Š</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <select id="role">
            <option value="client">å§”è¨—äºº</option>
            <option value="contractor">æ¥æ¡ˆäºº</option>
        </select>
        <button onclick="doRegister()">è¨»å†Š</button>
        <button onclick="doLogin()">ç™»å…¥</button>
    </div>

    <!-- å§”è¨—äºº -->
    <div id="client" class="card hidden">
        <h2>å§”è¨—äººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="clientName"></strong></p>
        <h3>å»ºç«‹å°ˆæ¡ˆ</h3>
        <input type="text" id="title" placeholder="å°ˆæ¡ˆæ¨™é¡Œ">
        <textarea id="desc" placeholder="å°ˆæ¡ˆæè¿°"></textarea>
        <input type="number" id="budget" placeholder="é ç®—">
        <!-- é™æ™‚ç«¶æ¨™æˆªæ­¢æ™‚é–“ -->
        <label for="deadline">æˆªæ­¢æ™‚é–“ï¼ˆé™æ™‚ç«¶æ¨™ï¼‰ï¼š</label>
        <input type="datetime-local" id="deadline">

        <button onclick="createProject()">å»ºç«‹å°ˆæ¡ˆ</button>
        <button onclick="loadMyProjects()">æŸ¥çœ‹æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="clientProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>

    <!-- æ¥æ¡ˆäºº -->
    <div id="contractor" class="card hidden">
        <h2>æ¥æ¡ˆäººé¢æ¿</h2>
        <p>ä½¿ç”¨è€…ï¼š<strong id="contractorName"></strong></p>
        <button onclick="loadOpenProjects()">ç€è¦½å°ˆæ¡ˆ</button>
        <div id="openProjects"></div>
        <button onclick="loadMyProjects()">æˆ‘çš„å°ˆæ¡ˆ</button>
        <div id="contractorProjects"></div>
        <button onclick="doLogout()">ç™»å‡º</button>
    </div>

    <script>
        const API = 'http://127.0.0.1:8080';
        let user = null;

        // ================== èº«åˆ†é©—è­‰ ==================

        function doRegister() {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };

            fetch(API + '/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
            })
            .catch(e => alert('éŒ¯èª¤ï¼š' + e));
        }

        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            fetch(API + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                user = d.user;
                if (!user) {
                    alert('ç™»å…¥å¤±æ•—');
                    return;
                }
                document.getElementById('auth').classList.add('hidden');
                
                if (user.role === 'client') {
                    document.getElementById('client').classList.remove('hidden');
                    document.getElementById('clientName').textContent = user.username;
                } else {
                    document.getElementById('contractor').classList.remove('hidden');
                    document.getElementById('contractorName').textContent = user.username;
                }
            })
            .catch(() => alert('ç™»å…¥å¤±æ•—'));
        }

        function doLogout() {
            user = null;
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('client').classList.add('hidden');
            document.getElementById('contractor').classList.add('hidden');
        }

        // ================== å°ˆæ¡ˆå»ºç«‹ / æŸ¥è©¢ ==================

        function createProject() {
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const budget = parseFloat(document.getElementById('budget').value);

			const deadlineInput = document.getElementById('deadline').value;
			let deadline = null;
			if (deadlineInput) {
				// ç›´æ¥å‚³å­—ä¸²ï¼Œä¸è½‰æ™‚å€
				deadline = deadlineInput + ':00';    // "2025-12-02T17:00:00"
			}

			const data = {
				title: title,
				description: desc,
				budget: budget,
				deadline: deadline
			};


            fetch(API + '/projects/?client_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                alert('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
                loadMyProjects();
            });
        }

        function formatDeadline(deadline) {
            if (!deadline) return 'æœªè¨­å®š';
            try {
                return new Date(deadline).toLocaleString();
            } catch {
                return deadline;
            }
        }

        function loadMyProjects() {
            fetch(API + '/projects/user/' + user.id)
            .then(r => r.json())
            .then(projects => {
                const html = projects.map(p =>
                    `<div style="background:#f9f9f9; padding:10px; margin:10px 0; border-left:3px solid #667eea;">
                        <strong>${p.title}</strong><br>
                        ${p.description}<br>
                        é ç®—: ${p.budget ?? 'æœªè¨­å®š'} |
                        ç‹€æ…‹: ${p.status}<br>
                        æˆªæ­¢æ™‚é–“: ${formatDeadline(p.deadline)}<br>
                        æœ€æ–°çµæ¡ˆç¶²å€: ${
							p.submission_file_url
							  ? `<a href="${API}${p.submission_file_url}" target="_blank" rel="noopener">ä¸‹è¼‰</a>`
							  : 'å°šæœªçµæ¡ˆ'
						}
                        ${getActions(p)}
                        <div id="versions-${p.id}" class="version-list"></div>
                    </div>`
                ).join('');
                
                if (user.role === 'client') {
                    document.getElementById('clientProjects').innerHTML = html;
                } else {
                    document.getElementById('contractorProjects').innerHTML = html;
                }
            });
        }

        function loadOpenProjects() {
            fetch(API + '/projects/')
            .then(r => r.json())
            .then(projects => {
                const html = projects.map(p =>
                    `<div style="background:#f9f9f9; padding:10px; margin:10px 0;">
                        <strong>${p.title}</strong><br>
                        ${p.description}<br>
                        é ç®—: ${p.budget ?? 'æœªè¨­å®š'}<br>
                        æˆªæ­¢æ™‚é–“: ${formatDeadline(p.deadline)}<br><br>
                        å ±åƒ¹é‡‘é¡ï¼š<input type="number" id="price-${p.id}" placeholder="é‡‘é¡"><br>
                        ææ¡ˆèªªæ˜ï¼š<input type="text" id="pdesc-${p.id}" placeholder="ç°¡çŸ­èªªæ˜"><br>
                        ä¸Šå‚³ææ¡ˆ PDFï¼š<input type="file" id="pfile-${p.id}" accept="application/pdf"><br>
                        <button class="sub-btn" onclick="makeProposal(${p.id})">æå‡ºå ±åƒ¹</button>
                    </div>`
                ).join('');
                document.getElementById('openProjects').innerHTML = html;
            });
        }

        // ================== ææ¡ˆï¼ˆå« PDF ä¸Šå‚³ï¼‰ ==================

        async function makeProposal(pid) {
            const priceInput = document.getElementById(`price-${pid}`);
            const descInput  = document.getElementById(`pdesc-${pid}`);
            const fileInput  = document.getElementById(`pfile-${pid}`);

            const priceVal = parseFloat(priceInput.value);
            const desc = descInput.value;
            const file = fileInput.files[0];

            if (isNaN(priceVal)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å ±åƒ¹é‡‘é¡');
                return;
            }
            if (!file) {
                alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„ PDF æª”æ¡ˆ');
                return;
            }
            if (file.type !== 'application/pdf') {
                alert('åƒ…æ¥å— PDF æª”æ¡ˆ');
                return;
            }

            const formData = new FormData();
            formData.append('price', priceVal);
            formData.append('description', desc);
            formData.append('file', file);

            try {
                const resp = await fetch(
                    API + '/projects/' + pid + '/proposals?contractor_id=' + user.id,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                const data = await resp.json();

                if (!resp.ok) {
                    alert('ææ¡ˆå¤±æ•—ï¼š' + (data.detail || JSON.stringify(data)));
                    return;
                }

                alert('ææ¡ˆå·²é€å‡ºï¼(ID: ' + (data.proposal_id || '') + ')');
            } catch (e) {
                alert('ææ¡ˆå¤±æ•—(ç¶²è·¯éŒ¯èª¤)ï¼š' + e);
            }
        }

        // ================== é¸æ“‡æ¥æ¡ˆäºº & çµæ¡ˆ ==================

        function selectContractor(pid) {
            fetch(API + `/projects/${pid}/proposals`)
            .then(r => r.json())
            .then(proposals => {
                if (proposals.length === 0) {
                    alert('ç›®å‰æ²’æœ‰ä»»ä½•ææ¡ˆ');
                    return;
                }
                const list = proposals.map((p, i) =>
                    `${i+1}. ææ¡ˆID:${p.id} / æ¥æ¡ˆäººID:${p.contractor_id} - $${p.price}`
                ).join('\n');
                const choice = prompt('é¸æ“‡æ¥æ¡ˆäººï¼š\n' + list);
                if (choice) {
                    const selected = proposals[parseInt(choice)-1];
                    if (!selected) {
                        alert('é¸æ“‡ç„¡æ•ˆ');
                        return;
                    }
                    fetch(API + `/projects/${pid}/select-contractor?contractor_id=${selected.contractor_id}`, {
                        method: 'POST'
                    })
                    .then(() => {
                        alert('å·²é¸æ“‡æ¥æ¡ˆäººï¼');
                        loadMyProjects();
                    });
                }
            });
        }

        async function submitWork(pid) {
            const fileInput = document.getElementById(`submit-file-${pid}`);
            if (!fileInput || fileInput.files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„çµæ¡ˆæª”æ¡ˆ');
                return;
            }
            const file = fileInput.files[0];

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch(API + `/projects/${pid}/submit`, {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    throw new Error(data.detail || resp.statusText);
                }

                alert('å·²æäº¤çµæ¡ˆï¼');
                loadMyProjects();
            } catch (e) {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + e);
            }
        }

        function acceptWork(pid) {
            fetch(API + `/projects/${pid}/accept`, {method: 'POST'})
            .then(() => {
                alert('å·²æ¥å—çµæ¡ˆï¼');
                loadMyProjects();
            });
        }

        function rejectWork(pid) {
            const reason = prompt('é€€ä»¶åŸå› ï¼š');
            if (!reason) return;

            fetch(API + `/projects/${pid}/reject`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rejection_reason: reason})
            })
            .then(() => {
                alert('å·²é€€ä»¶ï¼');
                loadMyProjects();
            });
        }

        // ================== çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨ï¼ˆä¸‹è¼‰é€£çµï¼‰ ==================

        function showSubmissionVersions(pid) {
            fetch(API + `/projects/${pid}/submissions`)
            .then(r => r.json())
            .then(data => {
                let list = [];
                if (Array.isArray(data)) {
                    list = data;
                } else if (data && Array.isArray(data.versions)) {
                    list = data.versions;
                }

                const container = document.getElementById(`versions-${pid}`);

                if (!list || list.length === 0) {
                    container.innerHTML = 'ç›®å‰æ²’æœ‰ä»»ä½•çµæ¡ˆç‰ˆæœ¬';
                    return;
                }

                const html = list.map(v =>
					`<div>v${v.version}ï¼š<a href="${API}${v.submit_url}" target="_blank" rel="noopener">ä¸‹è¼‰</a></div>`
				).join('');


                container.innerHTML = html;
            })
            .catch(e => {
                alert('è®€å–ç‰ˆæœ¬åˆ—è¡¨å¤±æ•—ï¼š' + e);
            });
        }

        // ================== æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯ ==================

        function getActions(p) {
            if (user.role === 'client') {
                if (p.status === 'open') {
                    return `<br>
                        <button class="sub-btn" onclick="editProject(${p.id})">ä¿®æ”¹å°ˆæ¡ˆ</button>
                        <button class="sub-btn" onclick="selectContractor(${p.id})">é¸æ“‡æ¥æ¡ˆäºº</button>`;
                } else if (p.status === 'submitted') {
                    return `<br>
                        <button class="sub-btn" onclick="acceptWork(${p.id})">æ¥å—</button>
                        <button class="sub-btn" onclick="rejectWork(${p.id})">é€€ä»¶</button>
                        <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                } else if (p.status === 'completed' || p.status === 'rejected') {
                    return `<br>
                        <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                }
            } else {
                if (p.contractor_id === user.id) {
                    if (p.status === 'in_progress' || p.status === 'rejected') {
                        return `<br>
                            <input type="file" id="submit-file-${p.id}">
                            <button class="sub-btn" onclick="submitWork(${p.id})">
                                ${p.status === 'rejected' ? 'é‡æ–°ä¸Šå‚³çµæ¡ˆ' : 'ä¸Šå‚³çµæ¡ˆ'}
                            </button>
                            <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                    } else if (p.status === 'completed' || p.status === 'submitted') {
                        return `<br>
                            <button class="sub-btn" onclick="showSubmissionVersions(${p.id})">çµæ¡ˆç‰ˆæœ¬åˆ—è¡¨</button>`;
                    }
                }
            }
            return '';
        }

        // ================== ä¿®æ”¹å°ˆæ¡ˆ ==================

        function editProject(pid) {
            fetch(API + `/projects/${pid}`)
            .then(r => r.json())
            .then(project => {
                const newTitle = prompt('ä¿®æ”¹æ¨™é¡Œï¼š', project.title);
                if (!newTitle) return;

                const newDesc = prompt('ä¿®æ”¹æè¿°ï¼š', project.description);
                if (!newDesc) return;

                const newBudget = prompt('ä¿®æ”¹é ç®—ï¼š', project.budget);
                if (!newBudget) return;

				const newDeadlineRaw = prompt(
					'ä¿®æ”¹æˆªæ­¢æ™‚é–“ (åŸå€¼ï¼š' + formatDeadline(project.deadline) + ')\næ ¼å¼ï¼šYYYY-MM-DD HH:MMï¼Œç•™ç©ºè¡¨ç¤ºä¸è®Š'
				);
				let deadline = project.deadline;
				if (newDeadlineRaw) {
					const safe = newDeadlineRaw.replace(' ', 'T');
					deadline = safe + ':00';  // ä¸€æ¨£ä¸è½‰ ISOï¼Œåªè£œç§’
				}


                fetch(API + `/projects/${pid}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDesc,
                        budget: parseFloat(newBudget),
                        deadline: deadline
                    })
                })
                .then(r => r.json())
                .then(() => {
                    alert('å°ˆæ¡ˆå·²æ›´æ–°ï¼');
                    loadMyProjects();
                })
                .catch(e => alert('æ›´æ–°å¤±æ•—ï¼š' + e));
            });
        }
    </script>
</body>
</html>
