<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkFlow | å°ˆæ¥­å·¥ä½œå§”è¨—å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--text-main);
            font-weight: 800;
            margin-bottom: 40px;
            font-size: 2.2rem;
            letter-spacing: -0.025em;
        }
        
        h1 i { color: var(--primary); margin-right: 10px; }

        h2 {
            font-size: 1.25rem;
            color: var(--text-main);
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 24px;
            transition: transform 0.2s;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* æŒ‰éˆ•æ¨£å¼ç³»çµ± */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .btn-secondary { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }

        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }

        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }

        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
            width: auto;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .hidden { display: none; }

        /* å°ˆæ¡ˆåˆ—è¡¨æ¨£å¼ */
        .project-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .project-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--primary);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .project-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        .badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-status { background: #e0e7ff; color: var(--primary); }
        .badge-budget { background: #dcfce7; color: #059669; }
        .badge-deadline { background: #fee2e2; color: #ef4444; }

        .project-meta {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .project-desc {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 15px;
        }

        .action-bar {
            border-top: 1px solid #f3f4f6;
            padding-top: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ç‰ˆæœ¬åˆ—è¡¨ */
        .version-list {
            margin-top: 10px;
            font-size: 0.85rem;
            background: #eff6ff;
            padding: 10px;
            border-radius: 6px;
            color: #1e40af;
        }
        .version-list a { color: var(--primary); font-weight: 600; }

        /* Modal æ¨£å¼å„ªåŒ– */
        .modal {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center; justify-content: center;
        }
        .modal.show { display: flex; animation: fadeIn 0.2s; }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%; max-width: 500px;
            padding: 0;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; flex-direction: column;
            max-height: 85vh;
        }

        .modal-header {
            padding: 15px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        
        .modal-body { padding: 20px; overflow-y: auto; }

        .close-btn { font-size: 24px; color: #9ca3af; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--text-main); }

        /* è©•è«–åˆ—è¡¨æ¨£å¼ */
        .review-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-sub); }
        .star-rating { color: #f59e0b; font-weight: bold; }

        /* å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .clickable-text { color: var(--primary); cursor: pointer; font-weight: 500; }
        .clickable-text:hover { text-decoration: underline; }
        
        .user-rating-box {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            color: #3730a3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fa-solid fa-rocket"></i> WorkFlow å¹³å°</h1>
        
        <div id="auth" class="card">
            <h2><i class="fa-solid fa-right-to-bracket"></i> ç™»å…¥ / è¨»å†Š</h2>
            <div style="margin-top: 20px;">
                <label>å¸³è™Ÿ</label>
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
                
                <label>Email</label>
                <input type="email" id="email" placeholder="example@email.com">
                
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                
                <label>é¸æ“‡èº«åˆ†</label>
                <select id="role">
                    <option value="client">æˆ‘æ˜¯å§”è¨—äºº (ç™¼æ¡ˆ)</option>
                    <option value="contractor">æˆ‘æ˜¯æ¥æ¡ˆäºº (æ¥æ¡ˆ)</option>
                </select>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-primary" onclick="doLogin()">ç™»å…¥</button>
                    <button class="btn-secondary" onclick="doRegister()">è¨»å†Š</button>
                </div>
            </div>
        </div>

        <div id="client" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fa-solid fa-user-tie"></i> å§”è¨—äººé¢æ¿</h2>
                <button class="btn-danger btn-sm" style="width: auto;" onclick="doLogout()">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> ç™»å‡º
                </button>
            </div>
            
            <p class="user-info">æ­¡è¿å›ä¾†ï¼Œ<strong id="clientName"></strong></p>
            
            <div class="card" style="border: 1px solid #e5e7eb; box-shadow: none;">
                <h3 style="margin-top: 0;"><i class="fa-solid fa-plus-circle"></i> å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
                <input type="text" id="title" placeholder="å°ˆæ¡ˆæ¨™é¡Œ">
                <textarea id="desc" placeholder="è«‹è©³ç´°æè¿°éœ€æ±‚..." rows="3"></textarea>
                
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label>é ç®— (NT$)</label>
                        <input type="number" id="budget" placeholder="ä¾‹å¦‚: 5000">
                    </div>
                    <div style="flex: 1;">
                        <label>æˆªæ­¢æ™‚é–“</label>
                        <input type="datetime-local" id="deadline">
                    </div>
                </div>

                <button class="btn-primary" onclick="createProject()">
                    <i class="fa-solid fa-paper-plane"></i> ç™¼å¸ƒå°ˆæ¡ˆ
                </button>
            </div>

            <div style="border-bottom: 2px solid #e5e7eb; margin: 30px 0;"></div>
            
            <h3><i class="fa-solid fa-list-check"></i> æˆ‘çš„å°ˆæ¡ˆåˆ—è¡¨</h3>
            <button class="btn-secondary" style="margin-bottom: 15px;" onclick="loadMyProjects()">
                <i class="fa-solid fa-rotate"></i> é‡æ–°æ•´ç†
            </button>
            <div id="clientProjects"></div>
        </div>

        <div id="contractor" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fa-solid fa-laptop-code"></i> æ¥æ¡ˆäººé¢æ¿</h2>
                <button class="btn-danger btn-sm" style="width: auto;" onclick="doLogout()">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> ç™»å‡º
                </button>
            </div>
            
            <p class="user-info">æ­¡è¿å›ä¾†ï¼Œ<strong id="contractorName"></strong></p>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-primary" onclick="loadOpenProjects()">
                    <i class="fa-solid fa-magnifying-glass"></i> ç€è¦½å¯æ¥æ¡ˆå°ˆæ¡ˆ
                </button>
                <button class="btn-secondary" onclick="loadMyProjects()">
                    <i class="fa-solid fa-folder-open"></i> æˆ‘çš„å°ˆæ¡ˆ
                </button>
            </div>

            <div id="openProjects"></div>
            <div id="contractorProjects"></div>
        </div>
    
        <div id="issuePanel" class="card hidden" style="border-left: 5px solid var(--warning);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; border: none; color: var(--warning);"><i class="fa-solid fa-triangle-exclamation"></i> Issue / å¾…è™•ç†äº‹é …</h2>
                <button class="btn-secondary btn-sm" onclick="closeIssuePanel()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="issueContent" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“œ è©³ç´°è©•è«–ç´€éŒ„</h3>
                <span class="close-btn" onclick="closeReviewModal()">&times;</span>
            </div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <script>
        const API = 'http://127.0.0.1:8080';
        let user = null;
        let currentIssueProjectId = null; 
        
        // ==========================================
        //  UI è¼”åŠ©å‡½æ•¸
        // ==========================================
        function getStatusBadge(status) {
            const map = {
                'draft': '<span class="badge badge-status" style="background:#cbd5e1; color:#475569">è‰ç¨¿</span>',
                'open': '<span class="badge badge-status" style="background:#dbeafe; color:#1e40af">é–‹æ”¾æ¥æ¡ˆ</span>',
                'in_progress': '<span class="badge badge-status" style="background:#fef3c7; color:#b45309">é€²è¡Œä¸­</span>',
                'submitted': '<span class="badge badge-status" style="background:#e0e7ff; color:#4338ca">å¾…é©—æ”¶</span>',
                'completed': '<span class="badge badge-status" style="background:#dcfce7; color:#15803d">å·²å®Œæˆ</span>',
                'rejected': '<span class="badge badge-status" style="background:#fee2e2; color:#b91c1c">å·²é€€ä»¶</span>'
            };
            return map[status] || `<span class="badge badge-status">${status}</span>`;
        }

        // ==========================================
        //  ã€è©•åƒ¹æ©Ÿåˆ¶åŠŸèƒ½å€ã€‘
        // ==========================================

        async function fetchAverageRating(userId) {
            try {
                const response = await fetch(API + '/projects/user/' + userId + '/average-rating');
                const data = await response.json();
                
                if (data.total_ratings > 0) {
                    const avgScore = data.average_score.toFixed(1); 
                    const stars = 'â˜…'.repeat(Math.round(avgScore)) + 'â˜†'.repeat(5 - Math.round(avgScore));
                    
                    return `
                        <span style="font-weight:bold; color:#f59e0b;">${avgScore}</span> ${stars} 
                        <span class="clickable-text" onclick="openReviewModal(${userId})" style="font-size:0.85em; color:#6b7280;">
                            (${data.total_ratings} ç­†è©•åƒ¹)
                        </span>
                    `;
                }
                return '<span style="color:#9ca3af; font-size:0.9em;">(æš«ç„¡è©•åƒ¹)</span>';
            } catch (e) {
                return 'ç„¡æ³•è¼‰å…¥';
            }
        }

        async function fetchUserReviews(userId) {
            try {
                const response = await fetch(API + `/projects/user/${userId}/reviews`);
                if (response.ok) return await response.json();
                return [];
            } catch (e) { return []; }
        }
        
        async function getRating(projectId, raterId) {
            try {
                const response = await fetch(API + `/projects/${projectId}/rate?rater_id=${raterId}`);
                if (response.ok) return await response.json();
                return null; 
            } catch (e) { return null; }
        }

        async function openReviewModal(userId) {
            const modal = document.getElementById('reviewModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>';
            modal.classList.add('show'); 

            const reviews = await fetchUserReviews(userId);

            if (reviews.length > 0) {
                let html = '<div class="review-list">';
                reviews.forEach(r => {
                    const commentText = r.comment ? r.comment : '<span style="color:#aaa; font-style:italic;">(ç„¡æ–‡å­—è©•è«–)</span>';
                    
                    const scores = [r.cooperation_attitude, r.output_quality, r.execution_efficiency, r.demand_reasonableness, r.acceptance_difficulty];
                    const validScores = scores.filter(s => s !== null && s !== undefined);
                    let finalScore = 0;
                    if (validScores.length > 0) {
                        const sum = validScores.reduce((a, b) => a + b, 0);
                        finalScore = (sum / validScores.length).toFixed(1);
                    }

                    html += `
                        <div class="review-item">
                            <div class="review-header">
                                <span><i class="fa-solid fa-user"></i> ID: ${r.rater_id}</span>
                                <span class="star-rating">â˜… ${finalScore}</span>
                            </div>
                            <div style="color:#374151;">${commentText}</div>
                        </div>`;
                });
                html += '</div>';
                modalBody.innerHTML = html;
            } else {
                modalBody.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">æ­¤ä½¿ç”¨è€…ç›®å‰æ²’æœ‰è©³ç´°æ–‡å­—è©•è«–ã€‚</p>';
            }
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target == modal) closeReviewModal();
        }

        function showRatingForm(projectId, ratedUserId, roleToRate, existingRating = null) {
            const targetDiv = document.getElementById(`rating-form-${projectId}`);
            const currentRaterId = user.id;
            
            const isUpdate = existingRating !== null;
            const actionText = isUpdate ? 'ä¿®æ”¹' : 'æäº¤';
            const btnClass = isUpdate ? 'btn-primary' : 'btn-success';
            
            const defaults = {
                cooperation: existingRating?.cooperation_attitude || 5.0,
                quality: existingRating?.output_quality || 4.5,
                efficiency: existingRating?.execution_efficiency || 4.0,
                reasonableness: existingRating?.demand_reasonableness || 4.0,
                difficulty: existingRating?.acceptance_difficulty || 3.5,
                comment: existingRating?.comment || ''
            };

            targetDiv.innerHTML = `
                <div style="padding: 20px; background: #fffbeb; border: 1px dashed #f59e0b; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin-top:0; color:#b45309;"><i class="fa-solid fa-star"></i> å° ${roleToRate} (ID: ${ratedUserId}) ${actionText}è©•åƒ¹</h4>
                    <form id="rate-form-${projectId}">
                        <input type="hidden" name="rater_id" value="${currentRaterId}">
                        <input type="hidden" name="rated_user_id" value="${ratedUserId}">
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label>åˆä½œæ…‹åº¦ (1-5)</label>
                                <input type="number" name="cooperation_attitude" value="${defaults.cooperation}" min="1.0" max="5.0" step="0.5" required>
                            </div>
                            
                            ${roleToRate === 'æ¥æ¡ˆäºº' ? `
                                <div><label>ç”¢å‡ºå“è³ª</label><input type="number" name="output_quality" value="${defaults.quality}" min="1.0" max="5.0" step="0.5"></div>
                                <div><label>åŸ·è¡Œæ•ˆç‡</label><input type="number" name="execution_efficiency" value="${defaults.efficiency}" min="1.0" max="5.0" step="0.5"></div>
                            ` : `
                                <div><label>éœ€æ±‚åˆç†æ€§</label><input type="number" name="demand_reasonableness" value="${defaults.reasonableness}" min="1.0" max="5.0" step="0.5"></div>
                                <div><label>é©—æ”¶é›£åº¦</label><input type="number" name="acceptance_difficulty" value="${defaults.difficulty}" min="1.0" max="5.0" step="0.5"></div>
                            `}
                        </div>
                        
                        <label>æ–‡å­—è©•è«–</label>
                        <textarea name="comment" rows="2" placeholder="è«‹è¼¸å…¥æ‚¨çš„è©•åƒ¹...">${defaults.comment}</textarea>
                        
                        <button type="submit" class="${btnClass}"><i class="fa-solid fa-check"></i> ç¢ºèª${actionText}</button>
                        <p id="message-${projectId}" style="margin-top: 5px; font-size:0.9rem;"></p>
                    </form>
                </div>
            `;

            document.getElementById(`rate-form-${projectId}`).addEventListener('submit', function(e) {
                e.preventDefault();
                submitRating(projectId, isUpdate);
            });
        }

        async function submitRating(projectId, isUpdate = false) {
            const form = document.getElementById(`rate-form-${projectId}`);
            const messageDiv = document.getElementById(`message-${projectId}`);
            const formData = new FormData(form);
            const data = {};

            for (const [key, value] of formData.entries()) {
                if (key !== 'comment' && value !== '') {
                    data[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
                } else if (key === 'comment') {
                    data[key] = value;
                }
            }
            Object.keys(data).forEach(key => (data[key] === '' || data[key] == null) && delete data[key]);

            messageDiv.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            messageDiv.style.color = 'blue';

            const method = isUpdate ? 'PUT' : 'POST';

            try {
                const response = await fetch(API + `/projects/${projectId}/rate`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (!isUpdate) {
                        const ratedUserId = data.rated_user_id;
                        const roleToRate = document.querySelector(`#rating-form-${projectId} h4`).innerText.includes('æ¥æ¡ˆäºº') ? 'æ¥æ¡ˆäºº' : 'å§”è¨—äºº';
                        await showRatingForm(projectId, ratedUserId, roleToRate, result);
                        messageDiv.textContent = `è©•åƒ¹æäº¤æˆåŠŸï¼`;
                    } else {
                        messageDiv.textContent = `è©•åƒ¹ä¿®æ”¹æˆåŠŸï¼`;
                    }
                    messageDiv.style.color = 'green';
                    loadMyProjects(); 
                    displayAverageRatingArea(user.id); 
                } else {
                    const err = await response.json();
                    if (response.status === 409 && !isUpdate) {
                        messageDiv.textContent = 'æäº¤å¤±æ•—ï¼šæ‚¨å·²è©•åƒ¹éã€‚';
                        messageDiv.style.color = 'orange';
                    } else {
                        throw new Error(err.detail || 'æ“ä½œå¤±æ•—');
                    }
                }
            } catch (error) {
                messageDiv.textContent = `éŒ¯èª¤: ${error.message}`;
                messageDiv.style.color = 'red';
            }
        }

        async function displayAverageRatingArea(userId) {
             const avgRatingText = await fetchAverageRating(userId);
             const targetDiv = document.getElementById(user.role === 'client' ? 'client' : 'contractor');
             
             let oldDiv = document.getElementById('user-avg-rating');
             if (oldDiv) oldDiv.remove();

             const avgDiv = document.createElement('div');
             avgDiv.id = 'user-avg-rating';
             avgDiv.className = 'user-rating-box';
             avgDiv.innerHTML = `<i class="fa-solid fa-medal fa-lg"></i> <div><strong>æˆ‘çš„ä¿¡ç”¨è©•åƒ¹</strong><br>${avgRatingText}</div>`;
             
             // æ’å…¥åˆ°æ¨™é¡Œå’ŒæŒ‰éˆ•ä¹‹é–“
             const h2 = targetDiv.querySelector('h2');
             h2.parentNode.insertBefore(avgDiv, h2.nextSibling.nextSibling);
        }

        // ==========================================
        //  ã€åŸºæœ¬åŠŸèƒ½ã€‘
        // ==========================================

        function doRegister() {
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };
            fetch(API + '/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥'))
            .catch(e => alert('éŒ¯èª¤ï¼š' + e));
        }

        function doLogin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            fetch(API + '/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                user = d.user;
                if (!user) { alert('ç™»å…¥å¤±æ•—'); return; }
                document.getElementById('auth').classList.add('hidden');
                
                if (user.role === 'client') {
                    document.getElementById('client').classList.remove('hidden');
                    document.getElementById('clientName').textContent = user.username;
                } else {
                    document.getElementById('contractor').classList.remove('hidden');
                    document.getElementById('contractorName').textContent = user.username;
                }
                loadMyProjects();
                displayAverageRatingArea(user.id);
            })
            .catch(() => alert('ç™»å…¥å¤±æ•—'));
        }

        function doLogout() {
            user = null;
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('client').classList.add('hidden');
            document.getElementById('contractor').classList.add('hidden');
            closeIssuePanel();
            window.location.reload(); 
        }

        function createProject() {
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const budget = parseFloat(document.getElementById('budget').value);
            const deadlineInput = document.getElementById('deadline').value;
            
            let deadline = null;
            if (deadlineInput) deadline = deadlineInput + ':00'; 

            fetch(API + '/projects/?client_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title, description: desc, budget, deadline })
            })
            .then(r => r.json())
            .then(() => {
                alert('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
                loadMyProjects();
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('title').value = '';
                document.getElementById('desc').value = '';
                document.getElementById('budget').value = '';
            });
        }

        function formatDeadline(deadline) {
            if (!deadline) return '<span style="color:#9ca3af">æœªè¨­å®š</span>';
            try {
                return new Date(deadline).toLocaleString();
            } catch { return deadline; }
        }

        function loadMyProjects() {
            fetch(API + '/projects/user/' + user.id)
            .then(r => r.json())
            .then(projects => {
                const projectPromises = projects.map(async p => {
                     let clientRatingText = '';
                     let contractorRatingText = '';
                     if (p.status === 'completed' && p.contractor_id) {
                        clientRatingText = await fetchAverageRating(p.client_id);
                        contractorRatingText = await fetchAverageRating(p.contractor_id);
                     }
                    const actionsHtml = await getActions(p);
                    const submissionLink = p.submission_file_url
                            ? `<a href="${API}${p.submission_file_url}" target="_blank" rel="noopener" class="clickable-text"><i class="fa-solid fa-download"></i> ä¸‹è¼‰æª”æ¡ˆ</a>`
                            : '<span style="color:#9ca3af">å°šæœªä¸Šå‚³</span>';

                    return `<div class="project-item">
                        <div class="project-header">
                            <span class="project-title">#${p.id} ${p.title}</span>
                            ${getStatusBadge(p.status)}
                        </div>
                        <div class="project-meta">
                            <span class="badge badge-budget"><i class="fa-solid fa-dollar-sign"></i> é ç®—: ${p.budget ?? 'æœªè¨­å®š'}</span>
                            <span class="badge badge-deadline"><i class="fa-regular fa-clock"></i> æˆªæ­¢: ${formatDeadline(p.deadline)}</span>
                        </div>
                        <div class="project-desc">${p.description}</div>
                        
                        <div style="font-size:0.9em; margin-bottom:15px; color:#4b5563;">
                            <strong>æœ€æ–°çµæ¡ˆæª”æ¡ˆï¼š</strong> ${submissionLink}
                        </div>
                        
                        ${p.status === 'completed' && p.contractor_id ? 
                            `<div style="margin-bottom: 15px; padding:10px; background:#f0f9ff; border-radius:8px; font-size:0.9em;">
                                <div style="margin-bottom:5px;"><strong>å§”è¨—äººä¿¡ç”¨:</strong> ${clientRatingText}</div>
                                <div><strong>æ¥æ¡ˆäººä¿¡ç”¨:</strong> ${contractorRatingText}</div>
                             </div>` : ''}
                             
                        <div class="action-bar">
                            ${actionsHtml}
                        </div>
                        <div id="versions-${p.id}" class="version-list" style="display:none;"></div>
                    </div>`;
                });

                Promise.all(projectPromises).then(htmlArray => {
                    const html = htmlArray.length ? htmlArray.join('') : '<p style="text-align:center; color:#9ca3af;">ç›®å‰æ²’æœ‰å°ˆæ¡ˆ</p>';
                    if (user.role === 'client') {
                        document.getElementById('clientProjects').innerHTML = html;
                    } else {
                        document.getElementById('contractorProjects').innerHTML = html;
                    }
                });
            });
        }

        function loadOpenProjects() {
            fetch(API + '/projects/')
            .then(r => r.json())
            .then(projects => {
                if(projects.length === 0) {
                    document.getElementById('openProjects').innerHTML = '<p style="text-align:center; color:#9ca3af;">ç›®å‰æ²’æœ‰é–‹æ”¾ä¸­çš„å°ˆæ¡ˆ</p>';
                    return;
                }
                
                const projectPromises = projects.map(async p => {
                    const clientRatingHtml = await fetchAverageRating(p.client_id);

                    return `<div class="project-item" style="border-left: 5px solid var(--warning);">
                        <div class="project-header">
                            <span class="project-title">${p.title}</span>
                            <span style="font-size:0.9em;">å§”è¨—äºº ID: ${p.client_id}</span>
                        </div>
                        
                        <div class="user-rating-box" style="padding:8px; margin-bottom:10px; font-size:0.9em;">
                            å§”è¨—äººä¿¡ç”¨: ${clientRatingHtml}
                        </div>

                        <div class="project-meta">
                            <span class="badge badge-budget">é ç®—: ${p.budget ?? 'æœªè¨­å®š'}</span>
                            <span class="badge badge-deadline">æˆªæ­¢: ${formatDeadline(p.deadline)}</span>
                        </div>

                        <div class="project-desc">${p.description}</div>
                        
                        <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                            <h4 style="margin-top:0; margin-bottom:10px;">æˆ‘è¦å ±åƒ¹</h4>
                            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                                <input type="number" id="price-${p.id}" placeholder="å ±åƒ¹é‡‘é¡ ($)">
                                <input type="text" id="pdesc-${p.id}" placeholder="ç°¡çŸ­èªªæ˜ææ¡ˆå…§å®¹">
                            </div>
                            <label style="font-size:0.85em; margin-bottom:5px;">ä¸Šå‚³ææ¡ˆ PDF (å¿…å¡«)</label>
                            <input type="file" id="pfile-${p.id}" accept="application/pdf">
                            <button class="btn-primary" onclick="makeProposal(${p.id})">
                                <i class="fa-solid fa-hand-point-up"></i> æå‡ºå ±åƒ¹
                            </button>
                        </div>
                    </div>`;
                });

                Promise.all(projectPromises).then(htmlArray => {
                    document.getElementById('openProjects').innerHTML = htmlArray.join('');
                });
            });
        }

        async function makeProposal(pid) {
            const priceInput = document.getElementById(`price-${pid}`);
            const descInput  = document.getElementById(`pdesc-${pid}`);
            const fileInput  = document.getElementById(`pfile-${pid}`);

            const priceVal = parseFloat(priceInput.value);
            if (isNaN(priceVal)) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å ±åƒ¹é‡‘é¡'); return; }
            if (!fileInput.files[0]) { alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„ PDF æª”æ¡ˆ'); return; }
            if (fileInput.files[0].type !== 'application/pdf') { alert('åƒ…æ¥å— PDF æª”æ¡ˆ'); return; }

            const formData = new FormData();
            formData.append('price', priceVal);
            formData.append('description', descInput.value);
            formData.append('file', fileInput.files[0]);

            try {
                const resp = await fetch(API + '/projects/' + pid + '/proposals?contractor_id=' + user.id, {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (!resp.ok) { alert('ææ¡ˆå¤±æ•—ï¼š' + (data.detail || JSON.stringify(data))); return; }
                alert('ææ¡ˆå·²é€å‡ºï¼');
                loadOpenProjects(); // Refresh
            } catch (e) { alert('ææ¡ˆå¤±æ•—ï¼š' + e); }
        }

        // ================== é¸æ“‡æ¥æ¡ˆäºº (å«è©³ç´°è©•åƒ¹é¡¯ç¤º) ==================

        function selectContractor(pid) {
            // æŒ‰éˆ•é¡¯ç¤ºè®€å–ä¸­
            const btn = document.activeElement; 
            if(btn && btn.tagName === 'BUTTON') btn.innerText = 'è®€å–è©•åƒ¹ä¸­...';

            fetch(API + `/projects/${pid}/proposals`)
            .then(r => r.json())
            .then(async proposals => { 
                if(btn && btn.tagName === 'BUTTON') btn.innerText = 'é¸æ“‡æ¥æ¡ˆäºº'; // é‚„åŸæŒ‰éˆ•

                if (proposals.length === 0) {
                    alert("âš ï¸ ç›®å‰é‚„æ²’æœ‰äººææ¡ˆå–”ï¼");
                    return;
                }

                // å¹³è¡Œè®€å–æ‰€æœ‰ææ¡ˆäººçš„ã€Œè©³ç´°è©•åƒ¹ã€
                const listPromises = proposals.map(async (p, i) => {
                    let scoreInfo = "å°šç„¡è©•åˆ†";
                    let commentsPreview = "   (æš«ç„¡æ–‡å­—è©•è«–)";

                    try {
                        // 1. æŠ“å–è©³ç´°è©•è«–åˆ—è¡¨
                        const res = await fetch(API + `/projects/user/${p.contractor_id}/reviews`);
                        const reviews = await res.json();

                        if (reviews.length > 0) {
                            // è¨ˆç®—å¹³å‡åˆ†
                            const totalScore = reviews.reduce((acc, cur) => acc + cur.cooperation_attitude, 0); // ç°¡åŒ–ï¼šåªç®—åˆä½œæ…‹åº¦å¹³å‡ï¼Œæˆ–ä½ å¯ä»¥ç”¨å¾Œç«¯ç®—å¥½çš„
                            
                            // ç¯©é¸å‡ºã€Œæœ‰å¯«å­—ã€çš„è©•è«–ï¼Œåªå–æœ€æ–°çš„ 2 ç­†
                            const textReviews = reviews
                                .filter(r => r.comment && r.comment.trim() !== "")
                                .slice(0, 2) // åªé¡¯ç¤ºå‰ 2 ç­†ï¼Œé¿å…è¦–çª—å¤ªé•·
                                .map(r => `   ğŸ’¬ "${r.comment}"`)
                                .join('\n');

                            // çµ„åˆé¡¯ç¤ºæ–‡å­—
                            scoreInfo = `â­ ${reviews.length} ç­†è©•åƒ¹`;
                            if (textReviews) {
                                commentsPreview = textReviews;
                            }
                        }
                    } catch (e) {
                        commentsPreview = "   (è®€å–å¤±æ•—)";
                    }
                    
                    // æœ€çµ‚æ’ç‰ˆ
                    return `ã€é¸é … ${i+1}ã€‘ æ¥æ¡ˆäºº ID: ${p.contractor_id}\n` +
                           `ğŸ’° å ±åƒ¹: $${p.price} | ${scoreInfo}\n` +
                           `ğŸ“„ ææ¡ˆ: ${p.description}\n` +
                           `ğŸ“ æ­·å²è©•åƒ¹åƒè€ƒ:\n${commentsPreview}\n` +
                           `----------------------------------`;
                });

                const listItems = await Promise.all(listPromises);
                
                // é¡¯ç¤ºé¸æ“‡è¦–çª—
                const listStr = listItems.join('\n');
                const choice = prompt('è«‹è¼¸å…¥ã€Œé¸é …ç·¨è™Ÿã€é¸æ“‡æ¥æ¡ˆäººï¼š\n\n' + listStr);
                
                if (choice) {
                    const index = parseInt(choice) - 1;
                    if (index >= 0 && index < proposals.length) {
                        const selected = proposals[index];
                        // äºŒæ¬¡ç¢ºèª
                        if(confirm(`ç¢ºå®šè¦é¸æ“‡ ID: ${selected.contractor_id} å—ï¼Ÿ\nå°ˆæ¡ˆå°‡é€²å…¥ã€Œé€²è¡Œä¸­ã€ç‹€æ…‹ã€‚`)) {
                            fetch(API + '/projects/' + pid + '/select-contractor?contractor_id=' + selected.contractor_id, {method: 'POST'})
                            .then(() => {
                                alert('âœ… å·²æˆåŠŸé¸æ“‡æ¥æ¡ˆäººï¼');
                                loadMyProjects();
                            })
                            .catch(e => alert('é¸æ“‡å¤±æ•—ï¼š' + e));
                        }
                    } else {
                        alert('âŒ ç·¨è™Ÿç„¡æ•ˆï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚');
                    }
                }
            })
            .catch(e => {
                alert('ç³»çµ±éŒ¯èª¤ï¼š' + e);
                if(btn) btn.innerText = 'é¸æ“‡æ¥æ¡ˆäºº';
            });
        }

        async function submitWork(pid) {
            const fileInput = document.getElementById(`submit-file-${pid}`);
            if (!fileInput || fileInput.files.length === 0) { alert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„çµæ¡ˆæª”æ¡ˆ'); return; }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const resp = await fetch(API + `/projects/${pid}/submit`, { method: 'POST', body: formData });
                if (!resp.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                alert('å·²æäº¤çµæ¡ˆï¼');
                loadMyProjects();
            } catch (e) { alert('ä¸Šå‚³å¤±æ•—ï¼š' + e); }
        }

        function acceptWork(pid) {
            if(!confirm('ç¢ºå®šè¦é©—æ”¶ä¸¦çµæ¡ˆå—ï¼Ÿ')) return;
            fetch(API + '/projects/' + pid + '/accept', {method: 'POST'})
            .then(async r => {
                if (!r.ok) {
                    let err = {}; try { err = await r.json(); } catch (_) {}
                    if (r.status === 400 && err.detail) {
                        alert('ç„¡æ³•çµæ¡ˆï¼š' + err.detail);
                        viewIssues(pid);
                    } else { throw new Error('failed'); }
                } else {
                    alert('å·²æ¥å—çµæ¡ˆï¼è«‹é€²è¡Œè©•åƒ¹ã€‚');
                    loadMyProjects();
                }
            })
            .catch(e => console.log(e));
        }

        function rejectWork(pid) {
            const reason = prompt('è«‹è¼¸å…¥é€€ä»¶åŸå› ï¼š');
            if (!reason) return;
            fetch(API + `/projects/${pid}/reject`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rejection_reason: reason})
            }).then(() => { alert('å·²é€€ä»¶ï¼'); loadMyProjects(); });
        }

        function showSubmissionVersions(pid) {
            fetch(API + `/projects/${pid}/submissions`)
            .then(r => r.json())
            .then(data => {
                let list = Array.isArray(data) ? data : (data.versions || []);
                const container = document.getElementById(`versions-${pid}`);
                container.style.display = 'block';
                
                if (list.length === 0) { container.innerHTML = 'ç„¡æ­·å²ç‰ˆæœ¬'; return; }
                container.innerHTML = '<strong><i class="fa-solid fa-code-branch"></i> æ­·å²ç‰ˆæœ¬ï¼š</strong><br>' + 
                    list.map(v => `v${v.version} (<span style="font-size:0.85em">${new Date(v.created_at).toLocaleString()}</span>)ï¼š<a href="${API}${v.submit_url}" target="_blank">ä¸‹è¼‰</a>`).join('<br>');
            });
        }

        // ================== ä¿®æ”¹å°ˆæ¡ˆ (å«æˆªæ­¢æ™‚é–“ä¿®æ­£ç‰ˆ) ==================

        function editProject(pid) {
            fetch(API + '/projects/' + pid)
            .then(r => r.json())
            .then(project => {
                // 1. ä¿®æ”¹æ¨™é¡Œ
                const newTitle = prompt('ä¿®æ”¹æ¨™é¡Œï¼š', project.title);
                if (newTitle === null) return; // æŒ‰å–æ¶ˆå‰‡ä¸­æ­¢

                // 2. ä¿®æ”¹æè¿°
                const newDesc = prompt('ä¿®æ”¹æè¿°ï¼š', project.description);
                if (newDesc === null) return;

                // 3. ä¿®æ”¹é ç®—
                const newBudget = prompt('ä¿®æ”¹é ç®—ï¼š', project.budget);
                if (newBudget === null) return;

                // 4. ä¿®æ”¹æˆªæ­¢æ™‚é–“ (è™•ç†æ—¥æœŸæ ¼å¼)
                // é¡¯ç¤ºç›®å‰çš„è¨­å®šå€¼ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…åƒè€ƒ
                let currentDeadlineStr = "";
                if (project.deadline) {
                    // æŠŠ "2025-12-31T23:59:00" è®Šæˆ "2025-12-31 23:59" æ–¹ä¾¿é–±è®€
                    currentDeadlineStr = project.deadline.replace('T', ' ').slice(0, 16);
                }

                const newDeadlineRaw = prompt(
                    `ä¿®æ”¹æˆªæ­¢æ™‚é–“ (ç›®å‰: ${currentDeadlineStr || 'æœªè¨­å®š'})\nè«‹è¼¸å…¥æ ¼å¼ï¼šYYYY-MM-DD HH:MM\n(è‹¥ä¸ä¿®æ”¹è«‹ç›´æ¥æŒ‰ç¢ºå®š)`,
                    currentDeadlineStr
                );

                let finalDeadline = project.deadline; // é è¨­ç¶­æŒåŸç‹€

                if (newDeadlineRaw !== null && newDeadlineRaw.trim() !== "") {
                    // ç°¡å–®è™•ç†ï¼šæŠŠç©ºç™½æ›æˆ Tï¼Œä¸¦è£œä¸Šç§’æ•¸ï¼Œè®Šæˆ ISO æ ¼å¼
                    const safe = newDeadlineRaw.trim().replace(' ', 'T');
                    
                    // æª¢æŸ¥æ ¼å¼æ˜¯å¦çœ‹èµ·ä¾†åƒæ—¥æœŸ (ç°¡å–®æª¢æŸ¥)
                    if (safe.length >= 10) {
                        // å¦‚æœä½¿ç”¨è€…åªè¼¸å…¥æ—¥æœŸ "2025-12-31"ï¼Œè£œä¸Šæ™‚é–“
                        if (!safe.includes('T')) {
                            finalDeadline = safe + 'T23:59:00';
                        } else {
                            // å¦‚æœæœ‰æ™‚é–“ "2025-12-31T12:00"ï¼Œè£œä¸Šç§’æ•¸
                            finalDeadline = safe.length === 16 ? safe + ':00' : safe;
                        }
                    }
                } else if (newDeadlineRaw === "") {
                    // å¦‚æœä½¿ç”¨è€…æ¸…ç©ºæ¬„ä½ï¼Œä»£è¡¨å–æ¶ˆæˆªæ­¢æ™‚é–“
                    finalDeadline = null;
                }

                // é€å‡ºä¿®æ”¹è«‹æ±‚
                fetch(API + `/projects/${pid}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: newTitle,
                        description: newDesc,
                        budget: parseFloat(newBudget),
                        deadline: finalDeadline
                    })
                })
                .then(r => {
                    if (!r.ok) throw new Error('ä¿®æ”¹å¤±æ•—');
                    return r.json();
                })
                .then(() => {
                    alert('âœ… å°ˆæ¡ˆå·²æˆåŠŸæ›´æ–°ï¼');
                    loadMyProjects();
                })
                .catch(e => alert('æ›´æ–°éŒ¯èª¤ï¼š' + e));
            });
        }

        // ========== Issue åŠŸèƒ½ ==========
        function closeIssuePanel() {
            document.getElementById('issuePanel').classList.add('hidden');
            currentIssueProjectId = null;
        }

        function createIssue(pid) {
            const title = prompt('Issue æ¨™é¡Œï¼š'); if (!title) return;
            const desc = prompt('Issue æè¿°ï¼š') || '';
            fetch(API + '/projects/' + pid + '/issues?creator_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, description: desc})
            }).then(r => r.ok ? r.json() : Promise.reject(r)).then(() => {
                alert('Issue å·²å»ºç«‹'); viewIssues(pid);
            }).catch(() => alert('å»ºç«‹å¤±æ•—'));
        }

        function viewIssues(pid) {
            currentIssueProjectId = pid;
            fetch(API + '/projects/' + pid + '/issues')
            .then(r => r.json())
            .then(issues => {
                const container = document.getElementById('issueContent');
                let html = `<h3 style="margin-top:0;">å°ˆæ¡ˆ #${pid} å¾…è™•ç†äº‹é …</h3>`;
                
                if (user.role === 'client') html += `<button class="btn-warning btn-sm" onclick="createIssue(${pid})"><i class="fa-solid fa-plus"></i> æ–°å¢ Issue</button>`;

                if (issues.length === 0) html += `<p style="color:#64748b;">ç›®å‰æ²’æœ‰ Issueï¼Œä¸€åˆ‡é †åˆ©ï¼</p>`;
                else {
                    html += issues.map(i => `
                        <div style="background:#fff; border-left:4px solid ${i.status === 'open' ? '#f59e0b' : '#10b981'}; padding:15px; margin-bottom:10px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${i.title}</strong>
                                <span class="badge" style="background:${i.status === 'open' ? '#fef3c7' : '#dcfce7'}; color:${i.status === 'open' ? '#b45309' : '#15803d'}">${i.status === 'open' ? 'å¾…è™•ç†' : 'å·²è§£æ±º'}</span>
                            </div>
                            <p style="margin:5px 0; color:#4b5563;">${i.description || ''}</p>
                            <div style="font-size:0.85em; color:#94a3b8; margin-bottom:10px;">${new Date(i.created_at).toLocaleString()}</div>
                            
                            <div style="display:flex; gap:5px;">
                                <button class="btn-secondary btn-sm" onclick="showIssueComments(${i.id})">ç•™è¨€ (${i.comments ? i.comments.length : 'æŸ¥çœ‹'})</button>
                                <button class="btn-secondary btn-sm" onclick="addIssueComment(${i.id})">æ–°å¢ç•™è¨€</button>
                                ${user.role === 'client' && i.status === 'open' ? `<button class="btn-success btn-sm" onclick="resolveIssue(${i.id})">æ¨™è¨˜å®Œæˆ</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                container.innerHTML = html;
                document.getElementById('issuePanel').classList.remove('hidden');
            });
        }

        function showIssueComments(issueId) {
            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments')
            .then(r => r.json())
            .then(comments => {
                const text = comments.length ? comments.map(c => `[${new Date(c.created_at).toLocaleTimeString()}] ç”¨æˆ·${c.sender_id}: ${c.content}`).join('\n') : 'ç„¡ç•™è¨€';
                alert(text); // ç°¡å–®è™•ç†
            });
        }

        function addIssueComment(issueId) {
            const content = prompt('ç•™è¨€å…§å®¹ï¼š'); if(!content) return;
            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/comments?sender_id=' + user.id, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content})
            }).then(() => alert('ç•™è¨€å·²é€å‡º'));
        }

        function resolveIssue(issueId) {
            if(!confirm('ç¢ºèªè§£æ±ºæ­¤ Issueï¼Ÿ')) return;
            fetch(API + '/projects/' + currentIssueProjectId + '/issues/' + issueId + '/resolve?resolver_id=' + user.id, {method: 'POST'})
            .then(() => { alert('å·²æ¨™è¨˜å®Œæˆ'); viewIssues(currentIssueProjectId); });
        }

        async function getActions(p) { 
            let buttons = '';
            
            // è©•åƒ¹èˆ‡ç‰ˆæœ¬åˆ—è¡¨
            if (p.status === 'completed' && p.contractor_id) {
                const ratedDivId = `rating-form-${p.id}`;
                let ratedUserId, roleToRate;
                if (user.role === 'client' && user.id === p.client_id) { ratedUserId = p.contractor_id; roleToRate = 'æ¥æ¡ˆäºº'; }
                else if (user.role === 'contractor' && user.id === p.contractor_id) { ratedUserId = p.client_id; roleToRate = 'å§”è¨—äºº'; }

                if (ratedUserId) {
                    const existingRating = await getRating(p.id, user.id);
                    if (existingRating) {
                        const ratingJson = JSON.stringify(existingRating).replace(/"/g, '&quot;');
                        buttons += `<button class="btn-primary btn-sm" onclick="showRatingForm(${p.id}, ${ratedUserId}, '${roleToRate}', ${ratingJson})"><i class="fa-solid fa-pen-to-square"></i> ä¿®æ”¹è©•åƒ¹</button>`;
                    } else {
                        buttons += `<button class="btn-success btn-sm" onclick="showRatingForm(${p.id}, ${ratedUserId}, '${roleToRate}')"><i class="fa-solid fa-star"></i> è©•åƒ¹å°æ–¹</button>`;
                    }
                    buttons += `<div id="${ratedDivId}"></div>`;
                }
                buttons += `<button class="btn-secondary btn-sm" onclick="showSubmissionVersions(${p.id})"><i class="fa-solid fa-clock-rotate-left"></i> æ­·å²çµæ¡ˆç‰ˆæœ¬</button>`;
            }
            
            // æ“ä½œæŒ‰éˆ•
            if (user.role === 'client') {
                if (p.status === 'open') {
                    buttons += `
                        <button class="btn-secondary btn-sm" onclick="editProject(${p.id})"><i class="fa-solid fa-pen"></i> ä¿®æ”¹</button>
                        <button class="btn-primary btn-sm" onclick="selectContractor(${p.id})"><i class="fa-solid fa-user-check"></i> é¸æ“‡æ¥æ¡ˆäºº</button>`;
                } else if (p.status === 'submitted') {
                    buttons += `
                        <button class="btn-warning btn-sm" onclick="viewIssues(${p.id})"><i class="fa-solid fa-list"></i> æª¢æŸ¥ Issue</button>
                        <button class="btn-secondary btn-sm" onclick="createIssue(${p.id})"><i class="fa-solid fa-plus"></i> æ Issue</button>
                        <button class="btn-success btn-sm" onclick="acceptWork(${p.id})"><i class="fa-solid fa-check"></i> é©—æ”¶é€šé</button> 
                        <button class="btn-danger btn-sm" onclick="rejectWork(${p.id})"><i class="fa-solid fa-xmark"></i> é€€ä»¶</button>
                        <button class="btn-secondary btn-sm" onclick="showSubmissionVersions(${p.id})"><i class="fa-solid fa-clock-rotate-left"></i> ç‰ˆæœ¬</button>`;
                }
            } else {
                // Contractor
                if (p.contractor_id === user.id) {
                    if (p.status === 'in_progress') {
                        buttons += `
                            <div style="margin-top:10px; display:flex; gap:5px; align-items:center;">
                                <input type="file" id="submit-file-${p.id}" style="margin:0; width:auto;">
                                <button class="btn-primary btn-sm" onclick="submitWork(${p.id})"><i class="fa-solid fa-upload"></i> ä¸Šå‚³çµæ¡ˆ</button>
                            </div>`;
                    } else if (p.status === 'rejected') {
                        buttons += `
                            <div style="margin-top:10px; display:flex; gap:5px; align-items:center;">
                                <input type="file" id="submit-file-${p.id}" style="margin:0; width:auto;">
                                <button class="btn-warning btn-sm" onclick="submitWork(${p.id})"><i class="fa-solid fa-rotate-right"></i> é‡æ–°ä¸Šå‚³</button>
                            </div>
                            <button class="btn-secondary btn-sm" onclick="showSubmissionVersions(${p.id})">æ­·å²ç‰ˆæœ¬</button>`;
                    } else if (p.status === 'submitted') {
                        buttons += `
                            <button class="btn-warning btn-sm" onclick="viewIssues(${p.id})"><i class="fa-regular fa-comments"></i> è¨è«– Issue</button>
                            <button class="btn-secondary btn-sm" onclick="showSubmissionVersions(${p.id})">æ­·å²ç‰ˆæœ¬</button>`;
                    }
                }
            }
            return buttons;
        }
    </script>
</body>
</html>`